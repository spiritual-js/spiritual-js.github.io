!function(window){"use strict";!function(){function extend(what,whit){Object.keys(whit).forEach(function(key){var def=whit[key];void 0===what[key]&&(def.get&&def.set||(what[key]=def))})}function strings(){extend(String.prototype,{trim:function(){return this.trimLeft().trimRight()},trimRight:function(){return this.replace(/\s+$/,"")},trimLeft:function(){return this.replace(/^\s*/,"")},repeat:function(n){return new Array(n+1).join(this)},startsWith:function(sub){return 0===this.indexOf(sub)},endsWith:function(sub){sub=String(sub);var i=this.lastIndexOf(sub);return i>=0&&i===this.length-sub.length},contains:function(){return console.warn("String.prototype.contains is deprecated. You can use String.prototype.includes"),this.includes.apply(this,arguments)},includes:function(){return-1!==String.prototype.indexOf.apply(this,arguments)},toArray:function(){return this.split("")}})}function arrays(){extend(Array,{every:function(array,fun,thisp){for(var res=!0,len=array.length>>>0,i=0;len>i;i++)if(void 0!==array[i]&&!fun.call(thisp,array[i],i,array)){res=!1;break}return res},forEach:function(array,fun,thisp){for(var len=array.length>>>0,i=0;len>i;i++)void 0!==array[i]&&fun.call(thisp,array[i],i,array)},map:function(array,fun,thisp){for(var m=[],len=array.length>>>0,i=0;len>i;i++)void 0!==array[i]&&m.push(fun.call(thisp,array[i],i,array));return m},filter:function(array,fun,thisp){return Array.prototype.filter.call(array,fun,thisp)},isArray:function(o){return"[object Array]"===Object.prototype.toString.call(o)},concat:function(a1,a2){function map(e){return e}return this.map(a1,map).concat(this.map(a2,map))}})}function functions(){extend(Function.prototype,{bind:function(oThis){if("function"!=typeof this)throw new TypeError("Function bind not callable");var fSlice=Array.prototype.slice,aArgs=fSlice.call(arguments,1),fToBind=this,Fnop=function(){},fBound=function(){return fToBind.apply(this instanceof Fnop?this:oThis||window,aArgs.concat(fSlice.call(arguments)))};return Fnop.prototype=this.prototype,fBound.prototype=new Fnop,fBound}})}function globals(){extend(window,{console:{log:function(){},debug:function(){},warn:function(){},error:function(){}}})}function effects(){extend(window,{requestAnimationFrame:function(){var func=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(){var lastTime=0;return function(callback,element){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}}();return func}(),cancelAnimationFrame:function(){return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||clearTimeout}(),setImmediate:function(){var list=[],handle=1,name="spiritual:emulated:setimmediate";return window.addEventListener("message",function(e){e.data===name&&list.length&&(list.shift().apply(window),e.stopPropagation())},!1),function(func){return list.push(func),window.postMessage(name,"*"),handle++}}()})}function extras(){extend(console,{debug:console.log}),extend(XMLHttpRequest.prototype,{overrideMimeType:function(){}}),extend(XMLHttpRequest,{UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4})}!function(isWorker){strings(),arrays(),functions(),globals(),extras(),isWorker||effects()}(!1)}(),window.gui=function(Namespace){return new Namespace("gui",{Namespace:Namespace,version:"-1.0.0",debug:!1,PARAM_CONTEXTID:"gui-contextid",PARAM_XHOST:"gui-xhost",BROADCAST_TODOM:"gui-broadcast-todom",BROADCAST_ONDOM:"gui-broadcast-ondom",BROADCAST_TOLOAD:"gui-broadcast-toload",BROADCAST_ONLOAD:"gui-broadcast-onload",BROADCAST_TOUNLOAD:"gui-broadcast-tounload",BROADCAST_ONUNLOAD:"gui-broadcast-unload",BROADCAST_WILL_UNLOAD:"gui-broadcast-will-unload",BROADCAST_MOUSECLICK:"gui-broadcast-mouseevent-click",BROADCAST_MOUSEMOVE:"gui-broadcast-mouseevent-mousemove",BROADCAST_MOUSEDOWN:"gui-broadcast-mouseevent-mousedown",BROADCAST_MOUSEUP:"gui-broadcast-mouseevent-mouseup",BROADCAST_SCROLL:"gui-broadcast-window-scroll",BROADCAST_RESIZE:"gui-broadcast-window-resize",BROADCAST_RESIZE_END:"gui-broadcast-window-resize-end",BROADCAST_POPSTATE:"gui-broadcast-window-popstate",BROADCAST_HASHCHANGE:"gui-broadcast-window-hashchange",BROADCAST_ORIENTATIONCHANGE:"gui-broadcast-orientationchange",BROADCAST_TWEEN:"gui-broadcast-tween",ACTION_DOC_ONDOMCONTENT:"gui-action-document-domcontent",ACTION_DOC_ONLOAD:"gui-action-document-onload",ACTION_DOC_ONHASH:"gui-action-document-onhash",ACTION_DOC_UNLOAD:"gui-action-document-unload",TIMEOUT_RESIZE_END:250,orientation:0,ORIENTATION_PORTRAIT:0,ORIENTATION_LANDSCAPE:1,$contextid:null,context:window,document:null,hosted:!1,xhost:"*",initialized:!1,unloading:!1,init:function(action,thisp){var is=this.initialized;return arguments.length&&(is?action.call(thisp):(this._initcallbacks=this._initcallbacks||[],this._initcallbacks.push(function(){if(gui.debug)try{action.call(thisp)}catch(exception){throw console.error(action.toString()),exception}else action.call(thisp)}))),is},ready:function(action,thisp){return this.init(action,thisp)},module:function(name,module){var Module;if(gui.Type.isString(name)&&name.length)return Module=gui.Module.extend(name,module||{}),module=gui.Module.$register(new Module(name));throw new Error("Module needs an identity token")},hasModule:function(name){return gui.Module.$hasModule(name)},namespaces:function(){return Namespace.namespaces.map(function(ns){return ns.$ns})},spacenames:function(){Namespace.namespaces.forEach(function(ns){ns.spacename()})},namespace:function(ns,members){var no;if(!gui.Type.isString(ns))throw new TypeError("Expected a namespace string");return no=gui.Object.lookup(ns),no=new gui.Namespace(ns),no=gui.Object.assert(ns,no),gui.Object.extend(no,members||{})},broadcastGlobal:function(msg,arg){gui.Type.isEvent(arg)&&(arg=new gui.EventSummary(arg)),gui.Broadcast.dispatchGlobal(msg,arg)},_initcallbacks:null,_exist:function(){return this.hosted=window!==parent,this.$contextid="key"+Math.random().toString().slice(2,11),this.hosted&&(this.xhost="*"),this},$initialize:function(){this.spacenames(),this.initialized=!0;var list=this._initcallbacks;if(list){for(;list.length;)list.shift()();this._initcallbacks=null}},$shutdown:function(){this.unloading=!0}})._exist()}(function(){function Namespace(ns,members){Namespace.namespaces.push(this),this.$ns=ns,members&&Object.keys(members).forEach(function(key){Object.defineProperty(this,key,Object.getOwnPropertyDescriptor(members,key))},this)}return Namespace.namespaces=[],Namespace.prototype={$ns:null,toString:function(){return"[namespace "+this.$ns+"]"},spacename:function(){return this._spacename(this,this.$ns),this},_spacename:function(o,name){gui.Object.each(o,function(key,value){"$superclass"!==key&&gui.Type.isConstructor(value)&&value.$classname===gui.Class.ANONYMOUS&&(Object.defineProperty(value,"$classname",{value:name+"."+key,enumerable:!0,writable:!1}),this._spacename(value,name+"."+key))},this)}},Namespace}()),gui.KeyMaster={generateKey:function(){var ran=Math.random().toString(),key="key"+ran.slice(2,11);return this._keys[key]?key=this.generateKey():this._keys[key]=!0,key},generateGUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"===c?r:3&r|8;return v.toString(16)}).toLowerCase()},isKey:function(string){var hit=null,looks=!1;return gui.Type.isString(string)&&(hit=this.extractKey(string),looks=hit&&hit[0]===string),looks},extractKey:function(string){return/key\d{9}/.exec(string)},_keys:Object.create(null)},gui.Object={create:function(proto,props){var resolved={};return Object.keys(props).forEach(function(prop){resolved[prop]={value:props[prop],writable:!0,enumerable:!0,configurable:!0}}),Object.create(proto,resolved)},extend:function(target,source,loose){var hiding=this._hiding;if(!gui.Type.isObject(source))throw new TypeError("Expected object, got "+gui.Type.of(source));return Object.keys(source).forEach(function(key){if(!loose||!gui.Type.isDefined(target[key])){var desc=Object.getOwnPropertyDescriptor(source,key);desc=hiding?gui.Object._hide(desc):desc,Object.defineProperty(target,key,desc)}},this),target},extendmissing:function(target,source){return this.extend(target,source,!0)},copy:function(source){try{return this.extend({},source)}catch(exception){throw new TypeError("Could not object-copy "+gui.Type.of(source))}},each:function(object,func,thisp){return Object.keys(object).map(function(key){return func.call(thisp,key,object[key])}).filter(function(result){return void 0!==result})},all:function(object,func,thisp){var res=[];for(var key in object)res.push(func.call(thisp,key,object[key]));return res.filter(function(result){return void 0!==result})},map:function(source,domap,thisp){var mapping,result={};return this.each(source,function(key,value){mapping=domap.call(thisp,key,value),void 0!==mapping&&(result[key]=mapping)}),result},lookup:function(opath,context){var result,struct=context||self;if(!gui.Type.isString(opath))throw new TypeError("Expected string, got "+gui.Type.of(opath));if(opath.includes(".")){var parts=opath.split(".");parts.every(function(part){return struct=struct[part],gui.Type.isDefined(struct)}),result=struct}else result=struct[opath];return result},assert:function(opath,value,context){var prop,struct=context||self;if(opath.includes(".")){var parts=opath.split(".");prop=parts.pop(),parts.forEach(function(part){struct=struct[part]||(struct[part]={})})}else prop=opath;return struct&&(struct[prop]=value),value},methods:function(object){var name,value,desc,obj=object,result=[];for(name in object){for(;!(desc=Object.getOwnPropertyDescriptor(obj,name));)obj=Object.getPrototypeOf(obj);"function"==typeof desc.value&&(value=object[name],gui.Type.isMethod(value)&&result.push(name))}return result},ownmethods:function(object){return Object.keys(object).filter(function(key){return gui.Type.isMethod(object[key])}).map(function(key){return key})},nonmethods:function(object){var result=[];for(var def in object)gui.Type.isFunction(object[def])||result.push(def);return result},bindall:function(object){var methods=Array.prototype.slice.call(arguments).slice(1);return methods.length||(methods=gui.Object.ownmethods(object).filter(function(name){return"_"!==name[0]})),methods.forEach(function(name){object[name]=object[name].bind(object)}),object},hidden:function(method){return gui.Object._hiding=!0,method.$hidden=!0,method},_hiding:!1,_hide:function(desc){return desc.value&&gui.Type.isFunction(desc.value)&&desc.value.$hidden&&desc.configurable&&(desc.enumerable=!1),desc}},gui.Type={of:function(o){var type={}.toString.call(o).match(this._typeexp)[1].toLowerCase();return"domwindow"===type&&"undefined"===String(typeof o)&&(type="undefined"),type},isDefined:function(o){return"undefined"!==this.of(o)},isComplex:function(o){switch(this.of(o)){case"undefined":case"boolean":case"number":case"string":case"null":return!1}return!0},isWindow:function(o){return o&&o.document&&o.location&&o.alert&&o.setInterval},isEvent:function(o){return this.of(o).endsWith("event")&&this.isDefined(o.type)},isElement:function(o){return this.of(o).endsWith("element")&&o.nodeType===Node.ELEMENT_NODE},isDocumentFragment:function(o){return o&&o.nodeName&&"#document-fragment"===o.nodeName},isDocument:function(o){return o&&o.nodeType===Node.DOCUMENT_NODE},isMethod:function(o){return o&&this.isFunction(o)&&!this.isConstructor(o)&&!String(o).includes("[native code]")},isSpirit:function(o){return o&&o instanceof gui.Spirit},isConstructor:function(what){return this.isFunction(what)&&this.isObject(what.prototype)&&Object.keys(what.prototype).length},isGuiClass:function(what){return this.isConstructor(what)&&what.$classname},isSpiritConstructor:function(what){return this.isFunction(what)&&this.isFunction(what.summon)},isArrayLike:function(what){return"0"in what&&!this.isArray(what)},cast:function(string){var result=String(string);switch(result){case"null":result=null;break;case"true":case"false":result="true"===result;break;default:String(parseInt(result,10))===result?result=parseInt(result,10):String(parseFloat(result))===result&&(result=parseFloat(result))}return result},_typeexp:/\s([a-zA-Z]+)/},function(){["array","function","object","string","number","boolean","null","arguments","file"].forEach(function(type){this["is"+type[0].toUpperCase()+type.slice(1)]=function(o){return this.of(o)===type}},this)}.call(gui.Type),gui.Object.bindall(gui.Type),gui.Array={of:function(){var slice=Array.prototype.slice;return Array.of||function(){return slice.call(arguments)}}(),from:function(){return Array.from||function(arg){for(var array=[],object=Object(arg),len=object.length>>>0,i=0;len>i;)i in object&&(array[i]=object[i]),i++;return array}}(),make:function(arg){switch(gui.Type.of(arg)){case"string":return arg.split(" ");case"array":return this.from(arg);default:return gui.Type.isArrayLike(arg)?this.from(arg):[arg]}},remove:function(array,from,to){var markers=gui.Array.from(arguments).slice(1);return markers.some(isNaN)?this.remove.apply(this,[array].concat(markers.map(function(m){return isNaN(m)?array.indexOf(m):m}))):(array.splice(from,!to||1+to-from+(!(0>to^from>=0)&&(0>to||-1)*array.length)),array.length)}},gui.Arguments={provided:function(){var types=gui.Array.from(arguments);return function(action){return function(){return gui.Arguments._match(arguments,types)?action.apply(this,arguments):void 0}}},confirmed:function(){var types=gui.Array.from(arguments);return function(action){return function(){return gui.Arguments._validate(arguments,types)?action.apply(this,arguments):void gui.Arguments._abort(this)}}},_validating:!1,_bugsummary:null,_match:function(args,types){return types.every(function(type,index){return this._matches(type,args[index],index)},this)},_validate:function(args,types){this._validating=!0;var is=this._match(args,types);return this._validating=!1,is},_xtract:function(xpect,optional){return optional?xpect.slice(1,-1):xpect},_matches:function(xpect,arg,index){var needs=!xpect.startsWith("("),split=this._xtract(xpect,!needs).split("|"),input=gui.Type.of(arg),match="*"===xpect||"node"===xpect&&arg&&arg.nodeType||"constructor"===xpect&&arg&&gui.Type.isConstructor(arg)||"element"===xpect&&arg&&arg.nodeType===Node.ELEMENT_NODE||"spirit"===xpect&&arg&&arg.$instanceid&&arg.element||!needs&&"undefined"===input||!needs&&split.indexOf("*")>-1||split.indexOf(input)>-1;return!match&&this._validating&&("string"===input&&(arg='"'+arg+'"'),this._bugsummary=[index,xpect,input,arg]),match},_abort:function(that){var summ=this._bugsummary,name=that.constructor.$classname||String(that);console.error(["Spiritual GUI: Bad argument "+summ.shift(),"for "+name+":","Expected "+summ.shift()+",","got "+summ.shift()+":",summ.shift()].join(" "))}},gui.Function={create:function(name,params,body,context){var F=context?context.Function:Function;return name=this.safename(name),params=params?params.join(","):"",body=body||"",new F("return function "+name+" ( "+params+" ) {"+body+"}")()},decorateBefore:gui.Arguments.confirmed("object|function","string","function")(function(target,name,decorator){return this._decorate("before",target,name,decorator)}),decorateAfter:gui.Arguments.confirmed("object|function","string","function")(function(target,name,decorator){return this._decorate("after",target,name,decorator)}),decorateAround:function(){throw new Error("TODO")},safename:function(name){return name&&name.includes(".")&&(name=name.split(".").pop()),name||""},_decorate:function(position,target,name,decorator){return target[name]=gui.Combo[position](decorator)(target[name]),target}},gui.Class={create:function(){var b=this._breakdown_base(arguments),C=this._createclass(null,b.proto,b.name);return gui.Object.extend(C.prototype,b.protos),gui.Object.extend(C,b.statics),gui.Property.extendall(b.protos,C.prototype),b.recurring&&gui.Object.each(b.recurring,function(key,val){var desc=Object.getOwnPropertyDescriptor(C,key);(!desc||desc.writable)&&(C[key]=C.$recurring[key]=val)}),C},get:function(classid){return this._classes[classid]||null},$constructor:function(){var constructor=this.$onconstruct||this.onconstruct,nonenumprop=gui.Property.nonenumerable,returnvalue=this;return Object.defineProperties(this,{$instanceid:nonenumprop({value:gui.KeyMaster.generateKey()}),displayName:nonenumprop({value:this.constructor.displayName,writable:!0})}),gui.Type.isFunction(constructor)&&(returnvalue=constructor.apply(this,arguments)),returnvalue||this},_classes:Object.create(null),ANONYMOUS:"Anonymous",_BODY:function($name){var body=$name.toString().trim();return body.slice(body.indexOf("{")+1,-1)}(function $name(){return this instanceof $name?gui.Class.$constructor.apply(this,arguments):$name.extend.apply($name,arguments)}),_breakdown_base:function(args){var named=gui.Type.isString(args[0]);return{name:named?args[0]:null,proto:args[named?1:0]||Object.create(null),protos:args[named?2:1]||Object.create(null),recurring:args[named?3:2]||Object.create(null),statics:args[named?4:3]||Object.create(null)}},_breakdown_subs:function(args){var named=gui.Type.isString(args[0]);return{name:named?args[0]:null,protos:args[named?1:0]||Object.create(null),recurring:args[named?2:1]||Object.create(null),statics:args[named?3:2]||Object.create(null)}},_createclass:function(SuperC,proto,name){name=name||gui.Class.ANONYMOUS;var C=function $Class(){return this instanceof $Class?gui.Class.$constructor.apply(this,arguments):$Class.extend.apply($Class,arguments)};return C.$classid=gui.KeyMaster.generateKey(),C.prototype=Object.create(proto||null),C.prototype.constructor=C,C=this._internals(C,SuperC),C=this._interface(C),C=this._classname(C,name),this._classes[C.$classid]=C,C},_createsubclass:function(SuperC,args){return args=this._breakdown_subs(args),this._extendclass(SuperC,args.protos,args.recurring,args.statics,args.name)},_extendclass:function(SuperC,protos,recurring,statics,name){var C=this._createclass(SuperC,SuperC.prototype,name);return gui.Object.extend(C,statics),gui.Object.extend(C.$recurring,recurring),gui.Object.each(C.$recurring,function(key,val){var desc=Object.getOwnPropertyDescriptor(C,key);(!desc||desc.writable)&&(C[key]=val)}),gui.Property.extendall(protos,C.prototype),C=this._classname(C,name)},_internals:function(C,SuperC){return C.$super=null,C.$subclasses=[],C.$superclass=SuperC||null,C.$recurring=SuperC?gui.Object.copy(SuperC.$recurring):Object.create(null),SuperC&&SuperC.$subclasses.push(C),C},_interface:function(C){return["extend","mixin","is"].forEach(function(method){C[method]=this[method]},this),C},_classname:function(C,name){return C.$classname=name||gui.Class.ANONYMOUS,Object.defineProperty(C.prototype,"$classname",{enumerable:!1,configurable:!0,get:function(){return this.constructor.$classname}}),C.toString=function(){return"[function "+this.$classname+"]"},C.prototype.toString=function(){return"[object "+this.constructor.$classname+"]"},C},_namedbody:function(name){return this._BODY.replace(new RegExp("\\$name","gm"),gui.Function.safename(name))}},gui.Object.extend(gui.Class,{extend:function(){return gui.Class._createsubclass(this,arguments)},mixin:function(proto,recurring,statics){return Array.forEach(arguments,function(mixins,i){mixins&&gui.Object.each(mixins,function(name,value){0===i?this.prototype[name]=value:gui.Class.descendantsAndSelf(this,function(C){C.$recurring[name]=value,C[name]=value})},this)},this),this},is:function(object){return gui.Type.isObject(object)&&object instanceof this},isInstance:function(){console.error("Deprecated API is derecated")}}),gui.Object.extend(gui.Class,{children:function(C,action,thisp){var results=[];return action=action||gui.Combo.identity,C.$subclasses.forEach(function(sub){results.push(action.call(thisp,sub))},thisp),results},descendants:function(C,action,thisp,results){return results=results||[],action=action||gui.Combo.identity,C.$subclasses.forEach(function(sub){results.push(action.call(thisp,sub)),gui.Class.descendants(sub,action,thisp,results)},thisp),results},descendantsAndSelf:function(C,action,thisp){var results=[];return action=action||gui.Combo.identity,results.push(action.call(thisp,C)),this.descendants(C,action,thisp,results)},parent:function(C,action,thisp){return C&&C.$superclass?(action=action||gui.Combo.identity,action.call(thisp,C.$superclass)):null},ancestors:function(C,action,thisp,results){return results=results||[],action=action||gui.Combo.identity,C.$superclass&&(results.push(action.call(thisp,C.$superclass)),gui.Class.ancestors(C.$superclass,action,thisp,results)),results},ancestorsAndSelf:function(C,action,thisp){var results=[];return action=action||gui.Combo.identity,results.push(action.call(thisp,C)),this.ancestors(C,action,thisp,results)},family:function(C,action,thisp){var results=this.ancestorsAndSelf(C).concat(this.descendants(C));return action&&(results=results.map(function(C){return action.call(thisp,C)})),results}}),gui.Property={extendall:function(source,target){return Object.keys(source).forEach(function(key){this.extend(source,target,key)},this),target},extend:function(source,target,key){var desc=Object.getOwnPropertyDescriptor(source,key);return desc=this._accessor(target,key,desc),Object.defineProperty(target,key,desc),target},nonenumerable:function(desc){return gui.Object.extendmissing({configurable:!0,enumerable:!1},desc)},accessor:function(object,key,def){if(this._isaccessor(def))return Object.defineProperty(object,key,{enumerable:!0,configurable:!0,get:def.getter||this._NOGETTER,set:def.setter||this._NOSETTER});throw new TypeError("Expected getter and/or setter method")},_isaccessor:function(obj){return Object.keys(obj).every(function(key){var is=!1;switch(key){case"getter":case"setter":is=gui.Type.isFunction(obj[key])}return is})},_accessor:function(proto,key,desc){var val=desc.value;return gui.Type.isObject(val)&&(val.getter||val.setter)&&this._isactive(val)&&(desc=this._activeaccessor(proto,key,val)),desc},_isactive:function(obj){return Object.keys(obj).every(function(key){var is=!1;switch(key){case"getter":case"setter":is=gui.Type.isFunction(obj[key])}return is})},_activeaccessor:function(proto,key,def){var desc;return["getter","setter"].forEach(function(name,set){for(;proto&&proto[key]&&!gui.Type.isDefined(def[name]);)proto=Object.getPrototypeOf(proto),desc=Object.getOwnPropertyDescriptor(proto,key),desc&&(def[name]=desc[set?"set":"get"])}),{enumerable:!0,configurable:!0,get:def.getter||this._NOGETTER,set:def.setter||this._NOSETTER}},_NOGETTER:function(){throw new Error("Getting a property that has only a setter")},_NOSETTER:function(){throw new Error("Setting a property that has only a getter")}},gui.Object.bindall(gui.Property),gui.Interface={validate:function(interfais,object){var is=!0,expected=interfais.toString(),type=gui.Type.of(object);switch(type){case"null":case"string":case"number":case"boolean":case"undefined":throw new Error("Expected "+expected+", got "+type+": "+object);default:try{var missing=null,t=null;if(is=Object.keys(interfais).every(function(name){return missing=name,t=gui.Type.of(interfais[name]),gui.Type.of(object[name])===t}),!is)throw new Error("Expected "+expected+". A required "+type+' "'+missing+'" is missing')}catch(exception){throw new Error("Expected "+expected)}}return is}},gui.Combo={before:function(decoration){return function(base){return function(){return decoration.apply(this,arguments),base.apply(this,arguments)}}},after:function(decoration){return function(base){return function(){var result=base.apply(this,arguments);return decoration.apply(this,arguments),result}}},around:function(decoration){var slice=[].slice;return function(base){return function(){var argv,callback,result,that=this;return argv=1<=arguments.length?slice.call(arguments,0):[],result=void 0,callback=function(){return result=base.apply(that,argv)},decoration.apply(this,[callback].concat(argv)),result}}},provided:function(condition){return function(base,otherwise){return function(){return condition.apply(this,arguments)?base.apply(this,arguments):otherwise?otherwise.apply(this,arguments):void 0}}},chained:function(base){return function(){var result=base.apply(this,arguments);return void 0===result?this:result}},memoized:function(base){var memos;return memos={},function(){var key;return key=JSON.stringify(arguments),memos.hasOwnProperty(key)?memos[key]:memos[key]=base.apply(this,arguments)}},identity:function(subject){return subject}},gui.Plugin=gui.Class.create(Object.prototype,{client:null,spirit:null,context:null,onconstruct:function(){},ondestruct:function(){},handleEvent:function(e){gui.Type.isFunction(this.onevent)&&this.onevent(e)},$destructed:!1,$onconstruct:function(client){this.client=client,gui.hasModule("gui-spirits@wunderbyte.com")&&client instanceof gui.Spirit&&(this.spirit=client||null,this.context=window),this.onconstruct()},$ondestruct:function(){}},{lazy:!0},{$prepare:function(spirit,prefix,Plugin){Object.defineProperty(spirit,prefix,{enumerable:!0,configurable:!0,get:function(){var plugin=new Plugin(this);return this.life.plugins[prefix]=!0,gui.Plugin.$assign(spirit,prefix,plugin),plugin}})},$assign:function(spirit,prefix,plugin){Object.defineProperty(spirit,prefix,{enumerable:!0,configurable:!0,get:function(){return plugin},set:function(){throw new Error('The property name "'+prefix+'" is reserved for the '+plugin.$classname+" and cannot be redefined.")}})}}),gui.SuperPlugin=function(suber){return gui.Plugin.extend({onconstruct:function(){suber.onconstruct.call(this),console.error(["Note that 'this.super' doesn't really exist. You can either:","1) compile the script serverside using 'grunt-spiritual-build' or","2) use the pattern 'SuperClass.prototype.methodname.apply(this)'","(the Grunt task basically just applies this pattern to the code)"].join("\n"))}})}(gui.Plugin.prototype),gui.TrackerPlugin=gui.Plugin.extend({onconstruct:function(){gui.Plugin.prototype.onconstruct.call(this),this._trackedtypes=Object.create(null),this.spirit&&(this._sig=gui.$contextid)},ondestruct:function(){gui.Plugin.prototype.ondestruct.call(this),gui.Object.each(this._trackedtypes,function(type,list){list.slice().forEach(function(checks){this._cleanup(type,checks)},this)},this)},toggle:function(arg,checks){console.error("TODO: SpiritTracker#toggle")},shift:function(on){var rest=gui.Array.from(arguments).slice(1);return on?this.add.apply(this,rest):this.remove.apply(this,rest)},shiftGlobal:function(on){return this._globalize(function(){return this.shift.apply(arguments)})},contains:function(arg){return gui.Array.make(arg).every(function(type){return this._trackedtypes[type]},this)},_global:!1,_trackedtypes:null,_sig:null,_globalize:function(operation){this._global=!0;var res=operation.call(this);return this._global=!1,res},_addchecks:function(type,checks){var result=!1,list=this._trackedtypes[type];return list?result=!this._haschecks(list,checks):(list=this._trackedtypes[type]=[],result=!0),result&&checks&&list.push(checks),result},_removechecks:function(type,checks){var result=!1,list=this._trackedtypes[type];if(list){var index=this._checksindex(list,checks);index>-1&&(result=!0,0===gui.Array.remove(list,index)&&delete this._trackedtypes[type])}return result},_containschecks:function(type,checks){var result=!1,list=this._trackedtypes[type];return list&&(result=!checks||this._haschecks(list,checks)),result},_haschecks:function(list,checks){var result=!checks||!1;return result||list.every(function(a){return a.every(function(b,i){return b===checks[i]})&&(result=!0),!result}),result},_hashandlers:function(){return Object.keys(this._trackedtypes).length>0},_checksindex:function(list,checks){var result=-1;return list.every(function(a,index){return a.every(function(b,i){return b===checks[i]})&&(result=index),-1===result}),result},_cleanup:function(type,checks){this._removechecks(type,checks)}}),gui.Action=function(confirmed,chained){return gui.hosted&&addEventListener("message",function(e){e.source===parent&&gui.Action.$maybeDescendGlobal(e.data)}),gui.Class.create(Object.prototype,{target:null,type:null,data:null,direction:null,global:!1,isConsumed:!1,isCancelled:!1,consumer:null,instanceid:null,onconstruct:function(json){gui.Object.extend(this,json)},consume:function(consumer){this.isConsumed=!0,this.consumer=consumer},cancel:function(consumer){this.isCancelled=!0,this.consume(consumer)}},{},{DESCEND:"descend",ASCEND:"ascend",IActionHandler:{onaction:function(a){},toString:function(){return"[interface ActionHandler]"}},add:confirmed("node","array|string","object|function")(chained(function(elm,type,handler){this._listen(!0,elm,type,handler,!1)})),remove:confirmed("node","array|string","object|function")(chained(function(node,type,handler){this._listen(!1,node,type,handler,!1)})),addGlobal:confirmed("node","array|string","object|function")(chained(function(node,type,handler){this._listen(!0,node,type,handler,!0)})),removeGlobal:confirmed("node","array|string","object|function")(chained(function(node,type,handler){this._listen(!1,node,type,handler,!0)})),dispatch:function(target,type,data){return this.ascend(target,type,data)},ascend:function(target,type,data){return this._dispatch(target,type,data,gui.Action.ASCEND,!1)},descend:function(target,type,data){return this._dispatch(target,type,data,gui.Action.DESCEND,!1)},dispatchGlobal:function(target,type,data){return this.ascendGlobal(target,type,data)},ascendGlobal:function(target,type,data){return this._dispatch(target,type,data,gui.Action.ASCEND,!0)},descendGlobal:function(target,type,data){return this._dispatch(target,type,data,gui.Action.DESCEND,!0)},stringify:function(a,key){var prefix="spiritual-action:";return prefix+function(){return a.target=null,a.data=function(d){if(gui.Type.isComplex(d))if(gui.Type.isFunction(d.stringify))d=d.stringify();else try{JSON.stringify(d)}catch(jsonexception){d=null}return d}(a.data),a.instanceid=key||null,JSON.stringify(a)}()},parse:function(msg){var prefix="spiritual-action:";return msg.startsWith(prefix)?new gui.Action(JSON.parse(msg.split(prefix)[1])):null},$maybeDescendGlobal:function(postmessage){var action,root,handlers,data=postmessage;gui.Type.isString(data)&&data.startsWith("spiritual-action:")&&(action=gui.Action.parse(data),action.direction===gui.Action.DESCEND&&((handlers=this._globals[action.type])&&handlers.slice().forEach(function(handler){handler.onaction(action)}),gui.hasModule("gui-spirits@wunderbyte.com")&&(root=gui.get("html"))&&(root.action.$handleownaction=!0,root.action.descendGlobal(action.type,action.data))))},_globals:{},_locals:{},_listen:function(add,node,type,handler,global){if(node.nodeType!==Node.DOCUMENT_NODE)throw new TypeError("Document node expected");var map=global?this._globals:this._locals,handlers=map[type],ok=gui.Action.IActionHandler;gui.Interface.validate(ok,handler)&&gui.Array.make(type).forEach(function(t){add?(handlers||(handlers=map[type]=[]),-1===handlers.indexOf(handler)&&handlers.push(handler)):handlers&&0===gui.Array.remove(handlers,handler)&&delete map[type]})},_dispatch:function(target,type,data,direction,global){var action=new gui.Action({target:target,type:type,data:data,direction:direction||gui.Action.ASCEND,global:global||!1}),crawler=new gui.Crawler(gui.CRAWLER_ACTION);return crawler.global=action.global||!1,crawler[action.direction](target,{handleSpirit:function(spirit){var directive=gui.Crawler.CONTINUE;return spirit.action.contains(type)&&(spirit.action.$onaction(action),action.isConsumed&&(directive=gui.Crawler.STOP,action.consumer=spirit)),directive},transcend:function(win,uri,key){var msg=gui.Action.stringify(action,key);win.postMessage(msg,"*")}}),action}})}(gui.Arguments.confirmed,gui.Combo.chained),gui.Broadcast=function(confirmed,chained){return window.addEventListener("message",function(e){gui.Type.isString(e.data)&&e.data.startsWith("spiritual-broadcast:")&&gui.Broadcast.$maybeBroadcastGlobal(e.data);
}),gui.Class.create(Object.prototype,{target:null,type:null,data:null,global:!1,$contextid:null,$contextids:null,$onconstruct:function(defs){gui.Object.extend(this,defs),this.$contextids=this.$contextids||[]}},{},{IBroadcastHandler:{onbroadcast:function(b){},toString:function(){return"[interface BroadcastHandler]"}},$target:null,_globals:Object.create(null),_locals:Object.create(null),add:chained(function(message,handler,sig){this._add(message,handler,sig||gui.$contextid)}),remove:chained(function(message,handler,sig){this._remove(message,handler,sig||gui.$contextid)}),addGlobal:chained(function(message,handler){this._add(message,handler)}),removeGlobal:chained(function(message,handler){this._remove(message,handler)}),dispatch:function(type,data){return gui.Type.isString(type)?this._dispatch({type:type,data:data,global:!1}):(console.error('The "target" argument (the first argument) of gui.Broadcast.dispatch is deprecated'),void this.dispatch(arguments[1],arguments[2]))},dispatchGlobal:function(type,data){return gui.Type.isString(type)?this._dispatch({type:type,data:data,global:!0,$contextid:gui.$contextid}):(console.error('The "target" argument (the first argument) of gui.Broadcast.dispatchGlobal is deprecated'),this.dispatchGlobal(arguments[1],arguments[2]))},stringify:function(b){var prefix="spiritual-broadcast:";return prefix+function(){return b.target=null,b.data=function(d){if(gui.Type.isComplex(d))if(gui.Type.isFunction(d.stringify))d=d.stringify();else try{JSON.stringify(d)}catch(jsonexception){d=null}return d}(b.data),JSON.stringify(b)}()},parse:function(msg){var prefix="spiritual-broadcast:";return msg.startsWith(prefix)?JSON.parse(msg.split(prefix)[1]):void 0},$maybeBroadcastGlobal:function(postmessage){var b=gui.Broadcast.parse(postmessage);-1===b.$contextids.indexOf(gui.$contextid)&&gui.Broadcast._dispatch(b)},_add:confirmed("array|string","object|function","(string)")(function(type,handler,sig){gui.Broadcast.IBroadcastHandler;if(gui.Type.isArray(type))type.forEach(function(t){this._add(t,handler,sig)},this);else{var map;sig?(map=this._locals[sig],map||(map=this._locals[sig]=Object.create(null))):map=this._globals,map[type]||(map[type]=[]);var array=map[type];-1===array.indexOf(handler)&&array.push(handler)}}),_remove:function(message,handler,sig){gui.Broadcast.IBroadcastHandler;if(gui.Type.isArray(message))message.forEach(function(msg){this._remove(msg,handler,sig)},this);else{var index,array=function(locals,globals){return sig?locals[sig]?locals[sig][message]:void 0:globals[message]}(this._locals,this._globals);array&&(index=array.indexOf(handler),index>-1&&gui.Array.remove(array,index))}},_dispatch:function(b){var map=b.global?this._globals:this._locals[gui.$contextid];if(gui.hasModule("gui-spirits@wunderbyte.com")&&(gui.spiritualized||b.type!==gui.BROADCAST_WILL_SPIRITUALIZE),this.$target&&(b.global||(b.target=this.$target),this.$target=null),b instanceof gui.Broadcast==!1&&(b=new gui.Broadcast(b)),map){var handlers=map[b.type];handlers&&handlers.slice().forEach(function(handler){handler.onbroadcast(b)})}return b.global&&this._propagate(b),b},_propagate:function(b){var postmessage=function(){return b.$contextids.push(gui.$contextid),gui.Broadcast.stringify(b)}();this._propagateDown(postmessage),this._propagateUp(postmessage,b.type)},_propagateDown:function(postmessage){var iframes=document.querySelectorAll("iframe");Array.forEach(iframes,function(iframe){iframe.contentWindow.postMessage(postmessage,"*")})},_propagateUp:function(postmessage){window!==top&&parent.postMessage(postmessage,"*")}})}(gui.Arguments.confirmed,gui.Combo.chained),function(confirmed){gui.Tick=function(type){this.type=type},gui.Tick.prototype={type:null,toString:function(){return"[object gui.Tick]"}},gui.Object.extend(gui.Tick,{toString:function(){return"[function gui.Tick]"},add:confirmed("string|array","object|function","(string)")(function(type,handler,sig){return this._add(type,handler,!1,sig||gui.$contextid)}),remove:confirmed("string|array","object|function","(string)")(function(type,handler,sig){return this._remove(type,handler,sig||gui.$contextid)}),one:confirmed("string|array","object|function","(string)")(function(type,handler,sig){return this._add(type,handler,!0,sig||gui.$contextid)}),next:function(action,thisp){setImmediate(function(){action.call(thisp)})},nextFrame:function(action,thisp){return requestAnimationFrame(function(timestamp){action.call(thisp,timestamp)})},cancelFrame:function(n){cancelAnimationFrame(n)},time:confirmed("function","(number)","(function|object)")(function(action,time,thisp){return setTimeout(function(){action.call(thisp)},time||0)}),cancelTime:function(n){clearTimeout(n)},start:confirmed("string","(number)")(function(type,time){var map=this._intervals;if(!map[type]){var tick=new gui.Tick(type);map[type]=setInterval(function(){this._doit(tick)}.bind(this),time||0)}}),stop:confirmed("string")(function(type){var map=this._intervals,id=map[type];id&&(clearInterval(id),delete map[type])}),dispatch:function(type,time,sig){return this._dispatch(type,time,sig||gui.$contextid)},_intervals:Object.create(null),_tempname:{types:Object.create(null),handlers:Object.create(null)},_add:function(type,handler,one,sig){if(gui.Type.isArray(type))type.forEach(function(t){this._add(t,handler,one,sig)},this);else{var list,index,map=this._tempname;list=map.handlers[type],list||(list=map.handlers[type]=[]),index=list.indexOf(handler),0>index&&(index=list.push(handler)-1),one&&(list._one=list._one||Object.create(null),list._one[index]=!0)}return this},_remove:function(type,handler,sig){if(gui.Type.isArray(type))type.forEach(function(t){this.remove(t,handler,sig)},this);else{var map=this._tempname,list=map.handlers[type];if(list){var index=list.indexOf(handler);0===gui.Array.remove(list,index)&&delete map.handlers[type]}}return this},_dispatch:function(type,time,sig){var map=this._tempname,types=map.types,tick=new gui.Tick(type);if(time=time||0,!types[type]){types[type]=!0;var that=this,id=null;id=time?setTimeout(function(){delete types[type],that._doit(tick)},time):setImmediate(function(){delete types[type],that._doit(tick)})}return tick},_doit:function(tick){var list=this._tempname.handlers[tick.type];list&&list.slice().forEach(function(handler){handler.ontick(tick)})}})}(gui.Arguments.confirmed),gui.Document=function(){function doaction(type,data){gui.hosted&&gui.Action.ascendGlobal(document,type,data)}function dobrodcast(){gui.Array.make(arguments).forEach(function(type){gui.Broadcast.dispatch(type)})}return gui.Class.create(Object.prototype,{onconstruct:function(){var that=this,add=function(target,events,capture){events.split(" ").forEach(function(type){target.addEventListener(type,that,capture)})};add(document,"DOMContentLoaded"),add(document,"click mousedown mouseup",!0),add(window,"load hashchange"),gui.hosted||add(window,"resize orientationchange"),window.chrome&&chrome.app&&chrome.runtime||add(window,"unload")},handleEvent:function(e){switch(e.type){case"click":case"mousedown":case"mouseup":this._onmouseevent(e);break;case"orientationchange":this._onrotate();break;case"resize":this._onresize();break;case"DOMContentLoaded":this._ondom();break;case"load":this._onload();break;case"unload":this._onunload();break;case"hashchange":this._onhashchange()}},_loaded:!1,_domloaded:!0,_timeout:-1,_ondom:function(){this._domloaded=!0,gui.$initialize(),this._configure(gui.namespaces()),doaction(gui.ACTION_DOC_ONDOMCONTENT,location.href),dobrodcast(gui.BROADCAST_TODOM,gui.BROADCAST_ONDOM)},_onload:function(){this._loaded=!0,dobrodcast(gui.BROADCAST_TOLOAD,gui.BROADCAST_ONLOAD),doaction(gui.ACTION_DOC_ONLOAD,location.href)},_onunload:function(){this._unloaded=!0,gui.$shutdown(),dobrodcast(gui.BROADCAST_TOUNLOAD,gui.BROADCAST_ONUNLOAD),doaction(gui.ACTION_DOC_UNLOAD,location.href)},_onhashchange:function(){doaction(gui.ACTION_DOC_ONHASH,location.hash)},_onmouseevent:function(e){gui.broadcastGlobal({click:gui.BROADCAST_MOUSECLICK,mousedown:gui.BROADCAST_MOUSEDOWN,mouseup:gui.BROADCAST_MOUSEUP}[e.type],gui.$contextid)},_onresize:function(){gui.hosted||(clearTimeout(this._timeout),this._timeout=setTimeout(function(){gui.broadcastGlobal(gui.BROADCAST_RESIZE_END)},gui.TIMEOUT_RESIZE_END))},_onrotate:function(){gui.hosted||(gui.orientation=window.innerWidth>window.innerHeight?1:0,gui.broadcastGlobal(gui.BROADCAST_ORIENTATIONCHANGE,gui.orientation))},_configure:function(spaces){var prop,def,metas=document.querySelectorAll("meta[name]");Array.forEach(metas,function(meta){prop=meta.getAttribute("name"),spaces.forEach(function(ns){prop.startsWith(ns+".")&&(def=gui.Object.lookup(prop),gui.Type.isDefined(def)?gui.Object.assert(prop,gui.Type.cast(meta.getAttribute("content"))):console.error('No definition for "'+prop+'"'))})})}})}(),gui.document=new gui.Document,gui.Module=gui.Class.create(Object.prototype,{oncontextinitialize:function(){},onrun:function(){},ondom:function(){},onload:function(){},onunload:function(){},$modname:null,$onconstruct:function(name){this.$modname=name,this.toString=function(){return"[module "+name+"]"}}},{},{$register:function(module){var name=module.$modname;if(this.$hasModule(name))throw new Error(name+" loaded twice?");return this._modules.push(module),gui.Type.isFunction(module.oncontextinitialize)&&module.oncontextinitialize(window),gui.Type.isFunction(module.onrun)&&module.onrun(),module},$hasModule:function(name){return this._modules.some(function(module){return module.$modname===name})},_modules:[]}),function(modules){gui.Object.each({ondom:gui.BROADCAST_TODOM,onload:gui.BROADCAST_TOLOAD,onunload:gui.BROADCAST_TOUNLOAD},function(action,broadcast){gui.Broadcast.add(broadcast,{onbroadcast:function(){modules.forEach(function(module){module[action]()})}})})}(gui.Module._modules),gui.Garbage={DENIAL:"Attempt to handle destructed object",toString:function(){return"[object gui.Garbage]"},ontick:function(t){"gui-tick-garbage-empty"===t.type&&window.gui&&this._nukemnow()},$collect:function(spirit){gui.unloading?this.$nuke(spirit):(this._spirits.push(spirit),gui.Tick.dispatch("gui-tick-garbage-empty"))},$nuke:function(spirit){var prefixes=[],plugins=spirit.life.plugins;gui.Object.each(plugins,function(prefix,instantiated){instantiated?"life"!==prefix&&prefixes.push(prefix):Object.defineProperty(spirit,prefix,{enumerable:!0,configurable:!0,get:function(){},set:function(){}})}),plugins=prefixes.map(function(key){return spirit[key]},this),gui.unloading||(this.$nukeplugins(plugins,!1),gui.Tick.next(function(){this.$nukeplugins(plugins,!0),this.$nukeelement(spirit),this.$nukeallofit(spirit)},this))},$nukeplugins:function(plugins,nuke){nuke?plugins.forEach(function(plugin){this.$nukeallofit(plugin)},this):plugins.map(function(plugin){return plugin.ondestruct(),plugin}).forEach(function(plugin){plugin.$ondestruct()})},$nukeelement:function(spirit){try{spirit.element.spirit=null}catch(denied){}},$nukeallofit:function(thing){var nativeprops=Object.prototype;if(!gui.unloading&&!thing.$destructed){thing.$destructed=!0;for(var prop in thing)if((thing.hasOwnProperty(prop)||gui.debug)&&void 0===nativeprops[prop]&&"$destructed"!==prop){var desc=Object.getOwnPropertyDescriptor(thing,prop);(!desc||desc.configurable)&&(gui.debug?this._definePropertyItentified(thing,prop):Object.defineProperty(thing,prop,this.DENIED))}}},DENIED:{enumerable:!0,configurable:!0,get:function(){gui.Garbage.DENY()},set:function(){gui.Garbage.DENY()}},DENY:function(message){var stack,e=new Error(gui.Garbage.DENIAL+(message?": "+message:""));!gui.Client.isExplorer&&(stack=e.stack)?(stack=gui.Client.isWebKit?stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@").split("\n"):stack.split("\n"),stack.shift(),stack.shift(),console.warn(e.message+"\n"+stack)):console.warn(e.message)},_spirits:[],_definePropertyItentified:function(thing,prop){Object.defineProperty(thing,prop,{enumerable:!0,configurable:!0,get:function(){gui.Garbage.DENY(thing)},set:function(){gui.Garbage.DENY(thing)}})},_nukemnow:function(){var spirit,spirits=this._spirits.slice();if(window.gui){for(;spirit=spirits.shift();)this.$nuke(spirit);this._spirits=[]}}},gui.Tick.add("gui-tick-garbage-empty",gui.Garbage),gui.URL=function(doc,href){if(!doc||doc.nodeType!==Node.DOCUMENT_NODE)throw new TypeError("Document expected");var val,link=gui.URL._createLink(doc,href);Object.keys(gui.URL.prototype).forEach(function(key){gui.Type.isString(val=link[key])&&("pathname"!==key||val.startsWith("/")||(val="/"+val),this[key]=val)},this),this.id=this.hash?this.hash.substring(1):null,this.external=this.href.split("#")[0]!==doc.URL.split("#")[0]},gui.URL.prototype={hash:null,host:null,hostname:null,href:null,pathname:null,port:null,protocol:null,search:null,id:null,external:!1,toString:function(){return this.href}},gui.URL.absolute=function(base,href){if(href=href||"",base.nodeType===Node.DOCUMENT_NODE)return new gui.URL(base,href).href;if("string"==typeof base){var stack=base.split("/"),parts=href.split("/");return stack.pop(),parts.forEach(function(part){"."!==part&&(".."===part?stack.pop():stack.push(part))}),stack.join("/")}},gui.URL.external=function(src,doc){doc=doc||document;var url=new gui.URL(doc,src);return url.host!==doc.location.host||url.port!==doc.location.port},gui.URL.getParam=function(url,name){name=name.replace(/(\[|\])/g,"\\$1");var results=new RegExp("[\\?&]"+name+"=([^&#]*)").exec(url);return null===results?null:results[1]},gui.URL.setParam=function(url,name,value){var cut,params=[],index=-1,path=url.split("#")[0],hash=url.split("#")[1];return path.indexOf("?")>-1&&(cut=path.split("?"),path=cut[0],params=cut[1].split("&"),params.every(function(param,i){var x=param.split("=");return x[0]===name&&(index=i,null!==value&&(x[1]=value,params[i]=x.join("="))),0>index})),null===value?index>-1&&params.remove(index,index):0>index&&(params[params.length]=[name,value].join("=")),params=params.length>0?"?"+params.join("&"):"",path+params+(hash?"#"+hash:"")},gui.URL.parametrize=function(baseurl,params){return gui.Type.isObject(params)&&gui.Object.each(params,function(key,value){switch(baseurl+=baseurl.includes("?")?"&":"?",gui.Type.of(value)){case"array":baseurl+=value.map(function(member){return key+"="+String(member)}).join("&");break;default:baseurl+=key+"="+String(value)}}),baseurl},gui.URL.origin=function(win){var loc=win.location;return loc.origin||loc.protocol+"//"+loc.host},gui.URL._createLink=function(doc,href){var link=doc.createElement("a");if(link.href=href||"",gui.Client.isExplorer){var uri=gui.URL.parseUri(link.href);Object.keys(uri).forEach(function(key){link[key]||(link[key]=uri[key])})}return link},gui.URL.parseUri=function(str){for(var o=gui.URL.parseOptions,m=o.parser[o.strictMode?"strict":"loose"].exec(str),uri={},i=14;i--;)uri[o.key[i]]=m[i]||"";return uri[o.q.name]={},uri[o.key[12]].replace(o.q.parser,function($0,$1,$2){$1&&(uri[o.q.name][$1]=$2)}),uri},gui.URL.parseOptions={strictMode:!0,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},gui.Then=function(callback,thisp){callback&&this.then(callback,thisp)},gui.Then.prototype={toString:function(){return"[object gui.Then]"},then:function(callback,thisp){this._callback=callback?callback:null,this._pointer=thisp?thisp:null,this._now&&this.now()},now:function(){var c=this._callback,p=this._pointer;c?(this.then(null,null),c.apply(p,arguments)):this._now=!0},_callback:null,_pointer:null,_now:!1},gui.HTMLParser={toString:function(){return"[object gui.HTMLParser]"},parse:function(markup,targetdoc){return this.parseAll(markup,targetdoc)[0]||null},parseAll:function(markup,targetdoc){return this.parseToNodes(markup,targetdoc).filter(function(node){return node.nodeType===Node.ELEMENT_NODE})},parseToNode:function(markup,targetdoc){return this.parseToNodes(markup,targetdoc)[0]||null},parseToNodes:function(markup,targetdoc){var elm,doc=this._document||(this._document=document.implementation.createHTMLDocument(""));return gui.Guide.suspend(function(){return doc.body.innerHTML=this._unsanitize(markup),elm=doc.querySelector("."+this._classname)||doc.body,Array.map(elm.childNodes,function(node){return(targetdoc||document).importNode(node,!0)})},this)},parseToDocument:function(markup){return markup=markup||"",gui.Guide.suspend(function(){var doc=document.implementation.createHTMLDocument("");if(markup.toLowerCase().includes("<!doctype"))try{doc.documentElement.innerHTML=markup}catch(ie9exception){doc=new ActiveXObject("htmlfile"),doc.open(),doc.write(markup),doc.close()}else doc.body.innerHTML=markup;return doc})},_classname:"_gui-htmlparser",_comments:/<!--[\s\S]*?-->/g,_firsttag:/^<([a-z]+)/i,_document:null,_unsanitize:function(markup){var match,fix;return markup=markup.trim().replace(this._comments,""),(match=markup.match(this._firsttag))&&(fix=this._unsanestructures[match[1]])&&(markup=fix.replace("${class}",this._classname).replace("${markup}",markup)),markup},_unsanestructures:function(){var map={td:'<table><tbody><tr class="${class}">${markup}</tr></tbody></table>',tr:'<table><tbody class="${class}">${markup}</tbody></table>',tbody:'<table class="${class}">${markup}</table>',col:'<table><colgroup class="${class}">${markup}</colgroup></table>',option:'<select class="${class}"><option>a</option>${markup}</select>'};return map.th=map.td,["thead","tfoot","caption","colgroup"].forEach(function(tag){map[tag]=map.tbody}),map}()},gui.EventSummary=function(e){this._construct(e)},gui.EventSummary.prototype={event:null,window:null,document:null,documentspirit:null,toString:function(){return"[object gui.EventSummary]"},_construct:function(e){var win=null,doc=null,target=e.target,type=target.nodeType;gui.Type.isDefined(type)?(doc=type===Node.DOCUMENT_NODE?target:target.ownerDocument,win=doc.defaultView):(win=target,doc=win.document),this.event=e,this.window=win,this.document=doc,this.documentspirit=doc.documentElement.spirit}},gui.Crawler=function(Type){return gui.Class.create(Object.prototype,{type:null,direction:null,global:!1,toString:function(){return"[object gui.Crawler]"},onconstruct:function(type){this.type=type||null},ascend:function(start,handler){this._stopped=!1,this.direction=gui.Crawler.ASCENDING;var win,supports=gui.hasModule("gui-spirits@wunderbyte.com"),isspirit=supports&&start instanceof gui.Spirit,elm=isspirit?start.element:start;do if(elm.nodeType===Node.DOCUMENT_NODE&&(this.global?(win=elm.defaultView,win.gui.hosted?win.gui.xhost?(elm=null,Type.isFunction(handler.transcend)&&handler.transcend(win.parent,win.gui.xhost,win.gui.$contextid)):elm=win.frameElement:elm=null):elm=null),elm){var directive=this._handleElement(elm,handler);switch(directive){case gui.Crawler.STOP:elm=null;break;default:elm=elm.parentNode}}while(elm)},ascendGlobal:function(start,handler){this.global=!0,this.ascend(start,handler),this.global=!1},descend:function(start,handler,arg){this._stopped=!1,this.direction=gui.Crawler.DESCENDING;var elm=start instanceof gui.Spirit?start.element:start;elm.nodeType===Node.DOCUMENT_NODE&&(elm=elm.documentElement),this._descend(elm,handler,arg,!0)},descendGlobal:function(start,handler,arg){this.global=!0,this.descend(start,handler,arg),this.global=!1},_stopped:!1,_descend:function(elm,handler,arg,start){var win,next,spirit,directive=this._handleElement(elm,handler,arg);switch(directive){case gui.Crawler.STOP:this._stopped=!0;break;case gui.Crawler.CONTINUE:case gui.Crawler.SKIP_CHILDREN:directive!==gui.Crawler.SKIP_CHILDREN&&(elm.childElementCount?this._descend(elm.firstElementChild,handler,arg,!1):this.global&&"iframe"===elm.localName&&(spirit=elm.spirit)&&spirit instanceof gui.IframeSpirit&&(win=elm.ownerDocument.defaultView,Type.isFunction(handler.transcend)&&handler.transcend(spirit.contentWindow,spirit.xguest,spirit.$instanceid))),this._stopped||!start&&(next=elm.nextElementSibling)&&this._descend(next,handler,arg,!1)}},_handleElement:function(element,handler,arg){var spirit,hasspirit=gui.hasModule("gui-spirits@wunderbyte.com"),directive=gui.Crawler.CONTINUE;return handler&&(Type.isFunction(handler.handleElement)&&(directive=handler.handleElement(element,arg)),!directive&&hasspirit&&(spirit=gui.get(element))&&(directive=spirit.oncrawler(this),directive||Type.isFunction(handler.handleSpirit)&&(directive=this._handleSpirit(spirit,handler)))),directive||(directive=gui.Crawler.CONTINUE),directive},_handleSpirit:function(spirit,handler){return handler.handleSpirit(spirit)}},{},{ASCENDING:"ascending",DESCENDING:"descending",CONTINUE:0,STOP:1,SKIP:2,SKIP_CHILDREN:4})}(gui.Type),gui.Request=function(url,doc){this._headers={Accept:"application/json"},url&&this.url(url,doc)},gui.Request.prototype=function(chained){return{url:chained(function(url,doc){this._url=doc?new gui.URL(doc,url).href:url}),sync:chained(function(){this._async=!1}),async:chained(function(){this._async=!0}),accept:chained(function(mimetype){this._headers.Accept=mimetype}),acceptJSON:chained(function(){this.accept("application/json")}),acceptXML:chained(function(){this.accept("text/xml")}),acceptText:chained(function(){this.accept("text/plain")}),format:chained(function(mimetype){this._format=mimetype}),override:chained(function(doit){this._override=doit||!0}),headers:chained(function(headers){if(!gui.Type.isObject(headers))throw new TypeError("Object expected");gui.Object.each(headers,function(name,value){this._headers[name]=String(value)},this)}),_async:!0,_url:null,_format:"application/json",_override:!1,_headers:null,_request:function(method,payload,callback){var that=this,request=new XMLHttpRequest,xtarget=gui.URL.external(this._url,document);xtarget&&window.XDomainRequest&&(request=new window.XDomainRequest),request.onreadystatechange=function(){if(this.readyState===XMLHttpRequest.DONE){var data=that._response(this.responseText);callback(this.status,data,this.responseText)}},this._override&&request.overrideMimeType(this._headers.Accept),request.open(method.toUpperCase(),this._url,!0),xtarget||gui.Object.each(this._headers,function(name,value){request.setRequestHeader(name,value,!1)}),request.send(payload)},_response:function(text){var result=text;try{switch(this._headers.Accept){case"application/json":result=JSON.parse(text);break;case"text/xml":result=(new DOMParser).parseFromString(text,"text/xml")}}catch(exception){gui.debug&&console.error(this._headers.Accept+" dysfunction at "+this._url)}return result}}}(gui.Combo.chained),["get","post","put","delete"].forEach(function(method){gui.Request.prototype[method]=function(payload){if(gui.Type.isFunction(payload))throw new Error("Deprecated: gui.Request returns a gui.Then");var then=new gui.Then;return payload="get"===method?null:payload,this._request(method,payload,function(status,data,text){then.now(status,data,text)}),then}}),gui.Client=function(){function supports(feature){var root=document.documentElement,fixt=feature[0].toUpperCase()+feature.substring(1);return!["","Webkit","Moz","O","ms"].every(function(prefix){return void 0===root.style[prefix?prefix+fixt:feature]})}function Client(){this.isExplorer=agent.includes("msie")||agent.includes("trident"),this.isExplorer9=this.isExplorer&&agent.includes("msie 9"),this.isExplorer10=this.isExplorer&&agent.includes("msie 10"),this.isExplorer11=this.isExplorer&&agent.includes("rv:11"),this.isWebKit=agent.includes("webkit")||agent.includes("opera"),this.isChrome=this.isWebKit&&agent.includes("chrome"),this.isSafari=this.isWebKit&&!this.isChrome&&agent.includes("safari"),this.isBlink=agent.includes("blink"),this.isGecko=!this.isExplorer&&!this.isWebKit&&!this.isOpera&&agent.includes("gecko"),this.isChromeApp=window.chrome&&window.chrome.app&&window.chrome.app.runtime?!0:!1,this.agent=function(){var agent="explorer";return this.isWebKit?agent="webkit":this.isGecko?agent="gecko":this.isOpera&&(agent="opera"),agent}.call(this),this.system=function(shortlist){var os=null;return shortlist.every(function(test){return agent.includes(test)&&(os=test.match(/ipad|iphone/)?"ios":test.replace(/ /g,"")),null===os}),os}(["window mobile","windows","ipad","iphone","os x","linux","haiku","amiga"]),this.hasTouch=void 0!==window.ontouchstart||this.isChrome,this.hasPointers=!1,this.hasBlob=window.Blob&&(window.URL||window.webkitURL),this.hasHistory=window.history&&window.history.pushState?!0:!1,this.isTouchDevice=function(shortlist){return shortlist.some(function(system){return agent.includes(system)})}(["android","webos","iphone","ipad","ipod","blackberry","windows phone"]),this.hasTransitions=supports("transition"),this.hasTransforms=supports("transform"),this.hasAnimations=supports("animationName"),this.has3D=supports("perspective"),this.hasFlex=supports("flex"),this.hasProxies=window.Proxy&&window.Proxy.create,this.hasPerformance=window.performance&&window.performance.now,Object.defineProperty(this,"hasFlexBox",{get:function(){console.error("Depracated API is deprecated: hasFlexBox >> hasFlex")}}),this.hasAnimationFrame=function(){var win=window;return win.requestAnimationFrame||win.webkitRequestAnimationFrame||win.mozRequestAnimationFrame||win.msRequestAnimationFrame||win.oRequestAnimationFrame?!0:!1}(),this.hasTemplates=function(template){return"content"in template?!0:!1}(document.createElement("template")),this.hasImports=function(link){return"import"in link?!0:!1}(document.createElement("link")),this.hasMutations=function(){return!["","WebKit","Moz","O","Ms"].every(function(vendor){return!gui.Type.isDefined(window[vendor+"MutationObserver"])})}(),this.scrollRoot=null,this.scrollBarSize=0,this.hasPositionFixed=!1}var agent=navigator.userAgent.toLowerCase();return new Client}(),Object.defineProperty(gui.Client,"isMobile",{get:function(){console.error("Deprecated API is deprecated: gui.Client.isMobile (use isTouchDevice)")}}),document.addEventListener("DOMContentLoaded",function(){if(gui.CSSPlugin){var win=window,doc=document,html=doc.documentElement,body=doc.body,root=null,temp=body.appendChild(gui.CSSPlugin.style(doc.createElement("div"),{position:"absolute",height:"10px",width:"10px",top:"100%"}));win.scrollBy(0,10),root=html.scrollTop?html:body,gui.Client.scrollRoot=root,gui.CSSPlugin.style(temp,{position:"fixed",top:"10px"});var has=10===temp.getBoundingClientRect().top;gui.Client.hasPositionFixed=has,body.removeChild(temp),win.scrollBy(0,-10);var inner=gui.CSSPlugin.style(document.createElement("p"),{width:"100%",height:"200px"}),outer=gui.CSSPlugin.style(document.createElement("div"),{position:"absolute",top:"0",left:"0",visibility:"hidden",width:"200px",height:"150px",overflow:"hidden"});outer.appendChild(inner),html.appendChild(outer);var w1=inner.offsetWidth;outer.style.overflow="scroll";var w2=inner.offsetWidth;w1===w2&&(w2=outer.clientWidth),html.removeChild(outer),gui.Client.scrollBarSize=w1-w2,gui.Client.isExplorer&&(gui.Client.scrollBarSize=17)}}),gui.MapList=function(confirmed,GuiArray){function MapList(Fit){this._map=Object.create(null),this._fit=Fit||null}return MapList.prototype={get:function(key){return this._map[key]},set:confirmed("string","array")(function(key,val){return this._map[key]=val}),has:function(key){return void 0!==this._map[key]},"delete":function(key){this._map[key]=null,delete this._map[key]},add:confirmed("string")(function(key,val){var list=this.get(key)||this.set(key,[]),puts=-1===list.indexOf(val);if(puts){if(this._fit&&!(val instanceof this._fit))throw new TypeError(val+" is not a "+this._fit);list.push(val)}return puts}),remove:confirmed("string")(function(key,val){var length,list=this.get(key);list&&(length=GuiArray.remove(list,val),0===length&&this["delete"](key))}),each:function(callback,thisp){gui.Object.each(this._map,function(key,list){callback.call(thisp,key,list)})},_map:null,_fit:null},MapList}(gui.Arguments.confirmed,gui.Array),gui.module("gui@wunderbyte.com"),gui=gui.Object.extend(gui,{mode:"robot",MODE_ROBOT:"robot",MODE_HUMAN:"human",MODE_FUNNY:"funny",autostart:!0,BROADCAST_KICKSTART:"gui-broadcast-kickstart",BROADCAST_WILL_SPIRITUALIZE:"gui-broadcast-will-spiritualize",BROADCAST_DID_SPIRITUALIZE:"gui-broadcast-did-spiritualize",ACTION_DOC_ONSPIRITUALIZED:"gui-action-document-spiritualized",$ACTION_XFRAME_VISIBILITY:"gui-action-xframe-visibility",LIFE_CONSTRUCT:"gui-life-construct",LIFE_CONFIGURE:"gui-life-configure",LIFE_ENTER:"gui-life-enter",LIFE_ATTACH:"gui-life-attach",LIFE_READY:"gui-life-ready",LIFE_DETACH:"gui-life-detach",LIFE_EXIT:"gui-life-exit",LIFE_ASYNC:"gui-life-async",LIFE_DESTRUCT:"gui-life-destruct",LIFE_VISIBLE:"gui-life-visible",LIFE_INVISIBLE:"gui-life-invisible",LIFE_RENDER:"gui-life-render",LIFE_IFRAME_CONSTRUCT:"gui-life-iframe-construct",LIFE_IFRAME_DOMCONTENT:"gui-life-iframe-domcontent",LIFE_IFRAME_SPIRITUALIZED:"gui-life-iframe-spiritualized",LIFE_IFRAME_ONLOAD:"gui-life-iframe-onload",LIFE_IFRAME_ONHASH:"gui-life-iframe-onhash",LIFE_IFRAME_UNLOAD:"gui-life-iframe-unload",$TICK_INSIDE:"gui-tick-spirits-inside",$TICK_OUTSIDE:"gui-tick-spirits-outside",CRAWLER_SPIRITUALIZE:"gui-crawler-spiritualize",CRAWLER_MATERIALIZE:"gui-crawler-materialize",CRAWLER_DETACH:"gui-crawler-detach",CRAWLER_DISPOSE:"gui-crawler-dispose",CRAWLER_ACTION:"gui-crawler-action",CRAWLER_VISIBLE:"gui-crawler-visible",CRAWLER_INVISIBLE:"gui-crawler-invisible",CRAWLER_REFLEX:"gui-crawler-reflex",CLASS_NOSPIRITS:"gui-nospirits",CLASS_INVISIBLE:"_gui-invisible",CLASS_HIDDEN:"_gui-hidden",spiritualized:!1,attributes:null,spiritualize:function(target){gui.Guide.$spiritualize(target||document)},spiritualizeSub:function(target){gui.Guide.$spiritualizeSub(target||document)},spiritualizeOne:function(target){gui.Guide.$spiritualizeOne(target||document)},materialize:function(target,webkithack){gui.Guide.$materialize(target||document,webkithack)},materializeSub:function(target){gui.Guide.$materializeSub(target||document)},materializeOne:function(target){gui.Guide.$materializeOne(target||document)},suspend:function(operation){return gui.DOMObserver.suspend(function(){return gui.Guide.suspend(operation)})},get:function(arg){var spirit,element,doc=document;switch(gui.Type.of(arg)){case"string":if(gui.KeyMaster.isKey(arg)&&(spirit=gui.Guide.$getSpiritById(arg)),!spirit)try{element=doc.querySelector(arg)||doc.querySelector("#"+arg)}catch(badselector){}finally{spirit=element?element.spirit:null}break;case"function":var sp,spirits=this._spirits.inside;gui.Type.isSpiritConstructor(arg)&&Object.keys(this._spirits.inside).some(function(key){return(sp=spirits[key]).constructor===arg?(spirit=sp,!0):void 0});break;default:if(!gui.Type.isElement(arg))throw new TypeError("gui.get("+arg+")");spirit=arg.spirit||null}return spirit||null},getAll:function(arg){console.error("TODO: gui.getAll")},channel:function(){gui.Guide.$channel.apply(gui.Guide,arguments)},hasChannels:function(){return gui.Guide.$hasChannels()},getChannels:function(){return gui.Guide.$getChannels()},ready:function(action,thisp){var is=this.spiritualized;return arguments.length&&(is?action.call(thisp):(this._readycallbacks=this._readycallbacks||[],this._readycallbacks.push(function(){if(gui.debug)try{action.call(thisp)}catch(exception){throw console.error(action.toString()),exception}else action.call(thisp)}))),is},_readycallbacks:null,_initspirits:function(){return this.attributes=["gui"],gui.Broadcast.add(gui.BROADCAST_TODOM,{onbroadcast:function(){gui.Guide.$startGuiding(),gui._nowready()}}),this},_nowready:function(){this.spiritualized=!0;var list=this._readycallbacks;if(list){for(;list.length;)list.shift()();this._readycallbacks=null}}}._initspirits()),gui.ActionPlugin=function(confirmed,chained){return gui.TrackerPlugin.extend({
type:null,data:null,add:confirmed("array|string","(object|function)")(chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.Action.IActionHandler,handler)&&gui.Array.make(arg).forEach(function(type){this._addchecks(type,[handler,this._global])},this)})),remove:confirmed("array|string","(object|function)")(chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.Action.IActionHandler,handler)&&gui.Array.make(arg).forEach(function(type){this._removechecks(type,[handler,this._global])},this)})),addGlobal:function(arg,handler){return this._globalize(function(){return this.add(arg,handler)})},removeGlobal:function(arg,handler){return this._globalize(function(){return this.remove(arg,handler)})},dispatch:confirmed("string","(*)")(function(type,data){return gui.Action.dispatch(this.spirit,type,data)}),ascend:confirmed("string","(*)")(function(type,data){return gui.Action.ascend(this.spirit,type,data)}),descend:confirmed("string","(*)")(function(type,data){return gui.Action.descend(this.spirit,type,data)}),dispatchGlobal:confirmed("string","(*)")(function(type,data){return gui.Action.dispatchGlobal(this.spirit,type,data)}),ascendGlobal:confirmed("string","(*)")(function(type,data){return gui.Action.ascendGlobal(this.spirit,type,data)}),descendGlobal:confirmed("string","(*)")(function(type,data){return gui.Action.descendGlobal(this.spirit,type,data)}),_cleanup:function(type,checks){var handler=checks[0],global=checks[1];global?this.removeGlobal(type,handler):this.remove(type,handler)},$handleownaction:!1,$onaction:function(action){var list=this._trackedtypes[action.type];list&&list.forEach(function(checks){var handler=checks[0],matches=checks[1]===action.global,hacking=handler===this.spirit&&this.$handleownaction;matches&&(handler!==action.target||hacking)&&handler.onaction(action)},this)}})}(gui.Arguments.confirmed,gui.Combo.chained),gui.BroadcastPlugin=function(chained,confirmed){return gui.TrackerPlugin.extend({add:confirmed("string|array")(chained(function(arg,handler){handler=handler?handler:this.spirit;var sig=this._global?null:this._sig;gui.Array.make(arg).forEach(function(type){this._addchecks(type,[handler,this._global])&&(this._global?gui.Broadcast.addGlobal(type,handler):gui.Broadcast.add(type,handler,sig))},this)})),remove:confirmed("string|array")(chained(function(arg,handler){handler=handler?handler:this.spirit;var sig=this._global?null:this._sig;gui.Array.make(arg).forEach(function(type){this._removechecks(type,[handler,this._global])&&(this._global?gui.Broadcast.removeGlobal(type,handler):gui.Broadcast.remove(type,handler,sig))},this)})),dispatch:confirmed("string|array")(function(arg,data){var result=null,global=this._global,sig=global?null:this._sig;return this._global=!1,gui.Array.make(arg).forEach(function(type){gui.Broadcast.$target=this.spirit,result=global?gui.Broadcast.dispatchGlobal(type,data):gui.Broadcast.dispatch(type,data,sig)},this),result}),addGlobal:function(arg,handler){return this._globalize(function(){return this.add(arg,handler)})},removeGlobal:function(arg,handler){return this._globalize(function(){return this.remove(arg,handler)})},shiftGlobal:function(on,arg,handler){return this._globalize(function(){return this.shift(on,arg,handler)})},dispatchGlobal:function(arg,data){return this._globalize(function(){return this.dispatch(arg,data)})},_cleanup:function(type,checks){var handler=checks[0],global=checks[1];global?gui.Broadcast.removeGlobal(type,handler):gui.Broadcast.remove(type,handler,this._sig)}})}(gui.Combo.chained,gui.Arguments.confirmed),gui.TickPlugin=function(chained,guiArray){return gui.TrackerPlugin.extend({add:chained(function(arg,handler,one){handler=handler?handler:this.spirit,gui.Interface.validate(gui.ITickHandler,handler)&&guiArray.make(arg).forEach(function(type){this._addchecks(type,[handler,this._global])&&this._add(type,handler,!1)},this)}),remove:chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.ITickHandler,handler)&&guiArray.make(arg).forEach(function(type){this._removechecks(type,[handler,this._global])&&this._remove(type,handler)},this)}),one:chained(function(arg,handler){this.add(arg,handler,!0)}),next:chained(function(action,thisp){gui.Tick.next(action,thisp||this.spirit)}),nextFrame:function(action,thisp){return gui.Tick.nextFrame(action,thisp||this.spirit)},cancelFrame:chained(function(n){gui.Tick.cancelFrame(n)}),time:function(action,time,thisp){return gui.Tick.time(action,time,thisp||this.spirit)},cancelTime:chained(function(n){gui.Tick.cancelTime(n)}),start:chained(function(type){gui.Tick.start(type)}),stop:chained(function(type){gui.Tick.stop(type)}),dispatch:function(type,time){return this._dispatch(type,time||0)},_global:!1,_add:function(type,handler,one){var sig=this.spirit.$contextid;one?this._global?gui.Tick.oneGlobal(type,handler):gui.Tick.one(type,handler,sig):this._global?gui.Tick.addGlobal(type,handler):gui.Tick.add(type,handler,sig)},_remove:function(type,handler){var sig=this.spirit.$contextid;this._global?gui.Tick.removeGlobal(type,handler):gui.Tick.remove(type,handler,sig)},_dispatch:function(type,time){var tick,sig=this.spirit.$contextid;return tick=this._global?gui.Tick.dispatchGlobal(type,time):gui.Tick.dispatch(type,time,sig)},_cleanup:function(type,checks){var handler=checks[0],bglobal=checks[1];this._remove(type,[handler])&&(bglobal?gui.Tick.removeGlobal(type,handler):gui.Tick.remove(type,handler,this.$contextid))}})}(gui.Combo.chained,gui.Array),gui.ITickHandler={toString:function(){return"[object ITickHandler]"},ontick:function(tick){}},gui.Life=function(target,type){this.target=target,this.type=type},gui.Life.prototype={target:null,type:null,toString:function(){return"[object gui.Life]"}},gui.LifePlugin=gui.TrackerPlugin.extend({constructed:!1,configured:!1,entered:!1,attached:!1,detached:!0,ready:!1,async:!1,exited:!1,destructed:!1,visible:void 0,rendered:!1,plugins:null,onconstruct:function(){gui.TrackerPlugin.prototype.onconstruct.call(this),this._handlers=Object.create(null),this.plugins=Object.create(null)},add:function(arg,handler){return handler=handler?handler:this.spirit,gui.Array.make(arg).forEach(function(type){this._addchecks(type,[handler])&&(this._handlers[type]||(this._handlers[type]=[]),this._handlers[type].push(handler))},this),this.spirit},remove:function(arg,handler){return handler=handler?handler:this.spirit,gui.Array.make(arg).forEach(function(type){if(this._removechecks(type,[handler])&&this._handlers[type]){var index=this._handlers[type].indexOf(type);gui.Array.remove(this._handlers[type],index),0===this._handlers[type].length&&delete this._handlers[type]}},this),this.spirit},dispatch:function(type){var list=this._handlers[type];if(list){var life=new gui.Life(this.spirit,type);switch(list.forEach(function(handler){handler.onlife(life)}),type){case gui.LIFE_CONSTRUCT:case gui.LIFE_CONFIGURE:case gui.LIFE_ENTER:case gui.LIFE_READY:case gui.LIFE_DETACH:case gui.LIFE_EXIT:case gui.LIFE_DESTRUCT:delete this._handlers[type]}}},_handlers:null,_cleanup:function(type,checks){var handler=checks[0];this.remove(type,handler)}}),gui.ConfigPlugin=gui.Plugin.extend({configureall:function(){var atts=this.spirit.element.attributes;Array.forEach(atts,function(att){this.configureone(att.name,att.value)},this)},onlife:function(l){var update;if(l.type===gui.LIFE_READY)for(;update=this._onready.shift();)update.action()},configureone:function(name,value){var hit,gux=this.spirit.window.gui,dot=gui.ConfigPlugin.SEPARATOR;gux.attributes.every(function(fix){return(hit=name.startsWith(fix+dot))&&this._evaluate(name,value,fix,dot),!hit},this)},_onready:null,_evaluate:function(name,value,fix,dot){var struct=this.spirit,success=!0,prop=null,cuts=null;name=prop=name.split(fix+dot)[1],name.indexOf(dot)>-1&&(cuts=name.split(dot),cuts.forEach(function(cut,i){gui.Type.isDefined(struct)?i<cuts.length-1?struct=struct[cut]:prop=cut:success=!1})),success&&gui.Type.isDefined(struct[prop])?this._schedule(struct,prop,this._revaluate(value)):console.error('No definition for "'+name+'" in '+this.spirit.toString())},_schedule:function(struct,prop,value){if(gui.Type.isFunction(struct[prop]))if(this.spirit.life.ready)struct[prop](value);else{if(this.spirit.life.add(gui.LIFE_READY,this),this._onready){this._onready.reduce(function(x,o,i){return o.struct===struct&&o.prop===prop?i:x},-1)}else this._onready=[];this._onready.push({struct:struct,prop:prop,action:function(){struct[prop](value)}})}else struct[prop]=value},_revaluate:function(value){return gui.Type.isString(value)&&(gui.hasModule("edbml@wunderbyte.com")&&value.startsWith("edbml.$get")?value=window.edbml.$get(gui.KeyMaster.extractKey(value)[0]):(value=gui.Type.cast(value),gui.Type.isString(value)&&(value=this._jsonvaluate(value)))),value},_jsonvaluate:function(value){if([["%5B","%5D"],["%7B","%7D"]].some(function(tokens){return value.startsWith(tokens[0])&&value.endsWith(tokens[1])}))try{value=JSON.parse(decodeURIComponent(value))}catch(exception){value=null,console.error(this+": Bad JSON: "+exception.message)}return value}},{lazy:!1,SEPARATOR:"."}),gui.Att=function(name,value){this.value=gui.Type.cast(value),this.name=this.type=name},gui.Att.prototype={name:null,type:null,value:null},gui.AttPlugin=function(confirmed,chained){return gui.TrackerPlugin.extend({get:function(name){return gui.AttPlugin.get(this.spirit.element,name)},set:chained(function(name,value){this.$suspended||gui.AttPlugin.set(this.spirit.element,name,value)}),has:function(name){return gui.AttPlugin.has(this.spirit.element,name)},del:chained(function(name){this.$suspended||gui.AttPlugin.del(this.spirit.element,name)}),all:function(){return gui.AttPlugin.all(this.spirit.element)},shift:confirmed("boolean","string")(chained(function(on,name,value){if(on){if(void 0===value)throw new TypeError('Missing value for "'+name+'"');this.set(name,value)}else this.del(name)})),getmap:function(){return gui.AttPlugin.getmap(this.spirit.element)},setmap:function(map){gui.AttPlugin.setmap(this.spirit.element,map)},add:confirmed("array|string","(object|function)")(chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.IAttHandler,handler)&&gui.Array.make(arg).forEach(function(type){this._addchecks(type,[handler]),this._onadd(type)},this)})),remove:confirmed("array|string","(object|function)")(chained(function(arg,handler){handler=handler?handler:this.spirit,gui.Interface.validate(gui.IAttHandler,handler)&&gui.Array.make(arg).forEach(function(type){this._removechecks(type,[handler])},this)})),$suspended:!1,$suspend:function(action){this.$suspended=!0;var res=action();return this.$suspended=!1,res},$onatt:function(name,value){var list,att,handler,trigger,triggers=!gui.attributes.every(function(prefix){return(trigger=name.startsWith(prefix))&&this.spirit.config.configureone(name,value),!trigger},this);!triggers&&(list=this._trackedtypes[name])&&(att=new gui.Att(name,value),list.forEach(function(checks){handler=checks[0],handler.onatt(att)},this))},_onadd:function(name){if(this.has(name)){var value=this.get(name);name.startsWith(gui.ConfigPlugin.PREFIX)?this.spirit.config.configureone(name,value):this.$onatt(name,value)}}},{},{get:function(elm,name){return gui.Type.cast(elm.getAttribute(name))},set:chained(function(elm,name,value){var spirit=elm.spirit,change=!1;this._ischecked(elm,name)?(change=elm.checked!==value,elm.checked="false"===String(value)?!1:null!==value,change&&spirit.att.$onatt(name,value)):this._isvalue(elm,name)?(change=elm.value!==String(value),change&&(elm.value=String(value),spirit.att.$onatt(name,value))):null===value?this.del(elm,name):(value=String(value),elm.getAttribute(name)!==value&&(spirit?(spirit.att.$suspend(function(){elm.setAttribute(name,value)}),spirit.att.$onatt(name,value)):elm.setAttribute(name,value)))}),_ischecked:function(elm,name){return elm.type&&void 0!==elm.checked&&"checked"===name},_isvalue:function(elm,name){return void 0!==elm.value&&"value"===name},has:function(elm,name){return elm.hasAttribute(name)},del:chained(function(elm,name){var spirit=elm.spirit;this._ischecked(elm,name)?elm.checked=!1:this._isvalue(elm,name)?elm.value="":spirit?(spirit.att.$suspend(function(){elm.removeAttribute(name)}),spirit.config.configureone(name,null)||spirit.att.$onatt(name,null)):elm.removeAttribute(name)}),all:function(elm){return gui.Array.from(elm.attributes)},getmap:function(elm){var map=Object.create(null);return this.all(elm).forEach(function(att){map[att.name]=gui.Type.cast(att.value)}),map},setmap:chained(function(elm,map){gui.Object.each(map,function(name,value){this.set(elm,name,value)},this)})})}(gui.Arguments.confirmed,gui.Combo.chained),gui.IAttHandler={toString:function(){return"[object IAttHandler]"},onatt:function(att){}},gui.BoxPlugin=gui.Plugin.extend({width:0,height:0,localX:0,localY:0,pageX:0,pageY:0,clientX:0,clientY:0,_scrollroot:function(){return function(doc){return"html"===gui.Client.scrollRoot.localName?doc.documentElement:doc.body}(this.spirit.document)}}),Object.defineProperties(gui.BoxPlugin.prototype,{width:{get:function(){return this.spirit.element.offsetWidth}},height:{get:function(){return this.spirit.element.offsetHeight}},localX:{get:function(){return this.spirit.element.offsetLeft}},localY:{get:function(){return this.spirit.element.offsetTop}},pageX:{get:function(){return this.clientX+this._scrollroot().scrollLeft}},pageY:{get:function(){return this.clientY+this._scrollroot().scrollTop}},clientX:{get:function(){return this.spirit.element.getBoundingClientRect().left}},clientY:{get:function(){return this.spirit.element.getBoundingClientRect().top}}}),gui.CSSPlugin=function(chained,confirmed){return gui.Plugin.extend({add:confirmed("string|array")(chained(function(name){var elm=this.spirit.element;gui.Array.make(name).forEach(function(n){gui.CSSPlugin.add(elm,n)})})),remove:confirmed("string|array")(chained(function(name){var elm=this.spirit.element;gui.Array.make(name).forEach(function(n){gui.CSSPlugin.remove(elm,n)})})),toggle:confirmed("string|array")(chained(function(name){var elm=this.spirit.element;gui.Array.make(name).forEach(function(n){gui.CSSPlugin.toggle(elm,n)})})),shift:confirmed("*","string|array")(chained(function(on,name){var elm=this.spirit.element;gui.Array.make(name).forEach(function(n){gui.CSSPlugin.shift(elm,on,n)})})),contains:confirmed("string")(function(name){return gui.CSSPlugin.contains(this.spirit.element,name)}),set:chained(function(prop,val){gui.CSSPlugin.set(this.spirit.element,prop,val)}),style:chained(function(map){gui.CSSPlugin.style(this.spirit.element,map)}),get:function(prop){return gui.CSSPlugin.get(this.spirit.element,prop)},compute:function(prop){return gui.CSSPlugin.compute(this.spirit.element,prop)},name:chained(function(name){var result=this.spirit.element.className;return void 0!==name&&(this.spirit.element.className=name,result=this.spirit),result}),matches:function(selector){return gui.CSSPlugin.matches(this.spirit.element,selector)}},{},{add:chained(function(element,name){if(gui.Type.isString(name))if(name.indexOf(" ")>-1&&(name=name.split(" ")),gui.Type.isArray(name))name.forEach(function(n){this.add(element,n)},this);else if(this._supports)element.classList.add(name);else{var now=element.className.split(" ");-1===now.indexOf(name)&&(now.push(name),element.className=now.join(" "))}}),remove:chained(function(element,name){if(gui.Type.isString(name))if(name=name||"",name.indexOf(" ")>-1&&(name=name.split(" ")),gui.Type.isArray(name))name.forEach(function(n){this.remove(element,n)},this);else if(this._supports)element.classList.remove(name);else{var now=element.className.split(" "),idx=now.indexOf(name);idx>-1&&gui.Array.remove(now,idx),element.className=now.join(" ")}}),toggle:chained(function(element,name){gui.Type.isString(name)&&(this._supports?element.classList.toggle(name):this.contains(element,name)?this.remove(element,name):this.add(element,name))}),shift:chained(function(element,on,name){on?this.add(element,name):this.remove(element,name)}),contains:function(element,name){if(this._supports)return element.classList.contains(name);var classnames=element.className.split(" ");return classnames.indexOf(name)>-1},set:chained(function(element,prop,value){gui.Type.isNumber(value)&&(value=(this._shorthands[prop]||"@").replace("@",value)),value=String(value),"float"===prop?prop="cssFloat":(value=this._jsvalue(value),prop=this._jsproperty(prop)),element.style[prop]=value}),get:function(element,prop){return prop=this._jsproperty(prop),this._jsvalue(element.style[prop])},style:function(thing,styles){var element=thing instanceof gui.Spirit?thing.element:thing;return gui.Object.each(styles,function(prop,value){this.set(element,prop,value)},this),thing},compute:function(thing,prop){var element=thing instanceof gui.Spirit?thing.element:thing;return prop=this._standardcase(this._jsproperty(prop)),window.getComputedStyle(element,null).getPropertyValue(prop)},matches:function(node,selector){var matches=!1;try{matches=node[this._matchmethod](selector)}catch(dysfunction){throw console.error('Invalid selector: "'+selector+'"'),dysfunction}return matches},_vendors:["","-webkit-","-moz-","-ms-","-o-"],_supports:void 0!==document.documentElement.classList,_camelcase:function(string){return string.replace(/-([a-z])/gi,function(all,letter){return letter.toUpperCase()})},_standardcase:function(string){return string.replace(/[A-Z]/g,function(all,letter){return"-"+string.charAt(letter).toLowerCase()})},_jsproperty:function(prop){var vendors=this._vendors,fixt=prop,element=document.documentElement;return prop=String(prop),prop.startsWith("-beta-")?vendors.every(function(vendor){var test=this._camelcase(prop.replace("-beta-",vendor));return void 0!==element.style[test]?(fixt=test,!1):!0},this):fixt=this._camelcase(fixt),fixt},_jsvalue:function(value){var vendors=this._vendors,element=document.documentElement;if(value=String(value),value&&value.includes("-beta-")){var parts=[];value.split(", ").forEach(function(part){(part=part.trim()).startsWith("-beta-")?vendors.every(function(vendor){var test=this._camelcase(part.replace("-beta-",vendor));return void 0!==element.style[test]?(parts.push(part.replace("-beta-",vendor)),!1):!0},this):parts.push(part)},this),value=parts.join(",")}return value},_cssproperty:function(prop){return this._standardcase(this._jsproperty(prop))},_cssvalue:function(value){return this._standardcase(this._jsvalue(value))},_shorthands:{top:"@px",right:"@px",bottom:"@px",left:"@px",width:"@px",height:"@px",maxWidth:"@px",maxHeight:"@px",minWidth:"@px",minHeight:"@px",textIndent:"@px",margin:"@px",marginTop:"@px",marginRight:"@px",marginBottom:"@px",marginLeft:"@px",padding:"@px",paddingTop:"@px",paddingRight:"@px",paddingBottom:"@px",paddingLeft:"@px",fontWeight:"@",opacity:"@",zIndex:"@",position:"@",display:"@",visibility:"@"},_matchmethod:function(){var match=null,root=document.documentElement;return["mozMatchesSelector","webkitMatchesSelector","msMatchesSelector","oMatchesSelector","matchesSelector"].every(function(method){return gui.Type.isDefined(root[method])&&(match=method),null===match}),match}()})}(gui.Combo.chained,gui.Arguments.confirmed),function(){function getset(prop){Object.defineProperty(gui.CSSPlugin.prototype,prop,{enumerable:!0,configurable:!0,get:function(){return this.spirit?parseInt(this.get(prop),10):void 0},set:function(val){this.set(prop,val)}})}var shorts=gui.CSSPlugin._shorthands;for(var prop in shorts)shorts.hasOwnProperty(prop)&&getset(prop)}(),gui.DOMPlugin=function(chained,guide,observer){return gui.Plugin.extend({id:chained(function(id){return id?void(this.spirit.element.id=id):this.spirit.element.id||null}),title:chained(function(title){var element=this.spirit.element;return gui.Type.isDefined(title)?void(element.title=title?title:""):element.title}),html:chained(function(html,position){return gui.DOMPlugin.html(this.spirit.element,html,position)}),outerHtml:chained(function(html){return gui.DOMPlugin.outerHtml(this.spirit.element,html)}),text:chained(function(text){return gui.DOMPlugin.text(this.spirit.element,text)}),empty:chained(function(){this.html("")}),hide:chained(function(){this.spirit.css.contains(gui.CLASS_HIDDEN)||(this.spirit.css.add(gui.CLASS_HIDDEN),gui.hasModule("gui-layout@wunderbyte.com")&&this.spirit.visibility&&this.spirit.visibility.off())}),show:chained(function(){this.spirit.css.contains(gui.CLASS_HIDDEN)&&(this.spirit.css.remove(gui.CLASS_HIDDEN),gui.hasModule("gui-layout@wunderbyte.com")&&this.spirit.visibility&&this.spirit.visibility.on())}),tag:function(){return this.spirit.element.localName},embedded:function(){return gui.DOMPlugin.embedded(this.spirit.element)},remove:function(){var parent=this.spirit.element.parentNode;parent.removeChild(this.spirit.element)},clone:function(){return this.spirit.element.cloneNode(!0)},ordinal:function(){return gui.DOMPlugin.ordinal(this.spirit.element)},compare:function(other){return gui.DOMPlugin.compare(this.spirit.element,other)},contains:function(other){return gui.DOMPlugin.contains(this.spirit.element,other)},containedBy:function(other){return gui.DOMPlugin.contains(other,this.spirit.element)},parseToNode:function(html){return gui.DOMPlugin.parseToNode(html)},parseToNodes:function(html){return gui.DOMPlugin.parseToNodes(html)}},{},{html:function(elm,html,pos){return gui.Type.isString(html)?pos?elm.insertAdjacentHTML(pos,html):void(gui.mode===gui.MODE_ROBOT?(gui.materializeSub(elm),gui.suspend(function(){elm.innerHTML=html}),gui.spiritualizeSub(elm)):elm.innerHTML=html):elm.innerHTML},outerHtml:function(elm,html){return gui.Type.isString(html)?void(gui.mode===gui.MODE_ROBOT?(gui.materialize(elm),gui.suspend(function(){elm.outerHTML=html}),gui.spiritualize(elm)):elm.outerHTML=html):elm.outerHTML},text:function(elm,text){var guide=gui.Guide;return gui.Type.isString(text)?void(gui.mode===gui.MODE_ROBOT?(guide.materializeSub(elm),gui.suspend(function(){elm.textContent=text})):elm.textContent=text):elm.textContent},ordinal:function(element){var result=0,parent=element.parentNode;if(parent)for(var node=parent.firstElementChild;node&&node!==element;)node=node.nextElementSibling,result++;return result},compare:function(node1,node2){return node1=node1 instanceof gui.Spirit?node1.element:node1,node2=node2 instanceof gui.Spirit?node2.element:node2,node1.compareDocumentPosition(node2)},contains:function(node,othernode){var check=Node.DOCUMENT_POSITION_CONTAINS+Node.DOCUMENT_POSITION_PRECEDING;return this.compare(othernode,node)===check},follows:function(node,othernode){return this.compare(othernode,node)===Node.DOCUMENT_POSITION_FOLLOWING},precedes:function(node,othernode){return this.compare(othernode,node)===Node.DOCUMENT_POSITION_PRECEDING},embedded:function(node){return node=node instanceof gui.Spirit?node.element:node,this.contains(node.ownerDocument,node)},group:function(nodes){function containedby(target,others){return others.some(function(other){return gui.DOMPlugin.contains(other,target)})}for(var node,groups=[];node=nodes.pop();)containedby(node,nodes)||groups.push(node);return groups},q:function(node,selector,type){var result=null;return this._qualify(node,selector)(function(node,selector){if(type)result=this.qall(node,selector,type)[0]||null;else try{result=node.querySelector(selector)}catch(exception){throw console.error("Dysfunctional selector: "+selector),exception}return result})},qall:function(node,selector,type){var result=[];return this._qualify(node,selector)(function(node,selector){return result=gui.Array.from(node.querySelectorAll(selector)),type&&(result=result.filter(function(el){return el.spirit&&el.spirit instanceof type}).map(function(el){return el.spirit})),result})},qdoc:function(selector,type){return this.q(document,selector,type)},qdocall:function(selector,type){return this.qall(document,selector,type)},_qualify:function(node,selector,action){var id,hadid=!0,regexp=this._thiskeyword;return node.nodeType===Node.ELEMENT_NODE&&regexp.test(selector)&&(hadid=node.id,id=node.id=node.id||gui.KeyMaster.generateKey(),selector=selector.replace(regexp,"#"+id),node=node.ownerDocument),function(action){var res=action.call(gui.DOMPlugin,node,selector);return hadid||(node.id=""),res}},_thiskeyword:/^this|,this/g})}(gui.Combo.chained,gui.Guide,gui.DOMObserver),gui.Object.bindall(gui.DOMPlugin),gui.DOMPlugin.mixin(gui.Object.map({q:function(selector,type){return gui.DOMPlugin.q(this.spirit.element,selector,type)},qall:function(selector,type){return gui.DOMPlugin.qall(this.spirit.element,selector,type)},qdoc:function(selector,type){return gui.DOMPlugin.qdoc(selector,type)},qdocall:function(selector,type){return gui.DOMPlugin.qdocall(selector,type)}},function(name,base){return function(){var selector=arguments[0],type=arguments[1];if(gui.Type.isString(selector)){if(1===arguments.length||gui.Type.isFunction(type))return base.apply(this,arguments);throw type=gui.Type.of(type),new TypeError("Unknown spirit for query: "+name+"("+selector+","+type+")")}throw new TypeError("Bad selector for query: "+name+"("+selector+")")}})),gui.DOMPlugin.mixin(gui.Object.map({next:function(type){var result=null,spirit=null,el=this.spirit.element;if(type){for(;null!==(el=el.nextElementSibling);)if(spirit=el.spirit,null!==spirit&&spirit instanceof type){result=spirit;break}}else result=el.nextElementSibling;return result},previous:function(type){var result=null,spirit=null,el=this.spirit.element;if(type){for(;null!==(el=el.previousElementSibling);)if(spirit=el.spirit,null!==spirit&&spirit instanceof type){result=spirit;break}}else result=el.previousElementSibling;return result},first:function(type){var result=null,spirit=null,el=this.spirit.element.firstElementChild;if(type)for(;null===result&&null!==el;)spirit=el.spirit,null!==spirit&&spirit instanceof type&&(result=spirit),el=el.nextElementSibling;else result=el;return result},last:function(type){var result=null,spirit=null,el=this.spirit.element.lastElementChild;if(type)for(;null===result&&null!==el;)spirit=el.spirit,null!==spirit&&spirit instanceof type&&(result=spirit),el=el.previoustElementSibling;else result=el;return result},parent:function(type){var result=this.spirit.element.parentNode;if(type){var spirit=result.spirit;result=spirit&&spirit instanceof type?spirit:null}return result},child:function(type){var result=this.spirit.element.firstElementChild;return type&&(result=this.children(type)[0]||null),result},children:function(type){var result=gui.Array.from(this.spirit.element.children);return type&&(result=result.filter(function(elm){return elm.spirit&&elm.spirit instanceof type}).map(function(elm){return elm.spirit})),result},ancestor:function(type){var result=this.parent();return type&&(result=null,(new gui.Crawler).ascend(this.spirit.element,{handleSpirit:function(spirit){return spirit instanceof type?(result=spirit,gui.Crawler.STOP):void 0}})),result},ancestors:function(type){var result=[],crawler=new gui.Crawler;return type?crawler.ascend(this.element,{handleSpirit:function(spirit){spirit instanceof type&&result.push(spirit)}}):crawler.ascend(this.element,{handleElement:function(el){result.push(el)}}),result},descendant:function(type){var result=this.child(),me=this.spirit.element;return type&&(new gui.Crawler).descend(me,{handleSpirit:function(spirit){return spirit instanceof type&&spirit.element!==me?(result=spirit,gui.Crawler.STOP):void 0}}),result},descendants:function(type){var result=[],me=this.spirit.element;return(new gui.Crawler).descend(me,{handleElement:function(element){type||element===me||result.push(element)},handleSpirit:function(spirit){type&&spirit instanceof type&&spirit.element!==me&&result.push(spirit)}}),result},following:function(type){for(var spirit,result=[],el=this.spirit.element;el=el.nextElementSibling;)type&&(spirit=el.spirit)?spirit instanceof type&&result.push(spirit):result.push(el);return result},preceding:function(type){for(var spirit,result=[],el=this.spirit.element;el=el.previousElementSibling;)type&&(spirit=el.spirit)?spirit instanceof type&&result.push(spirit):result.push(el);return result},siblings:function(type){return this.preceding(type).concat(this.following(type))}},function(name,base){return function(Type){if(!gui.Type.isDefined(Type)||gui.Type.isFunction(Type))return base.apply(this,arguments);throw new TypeError("Unknown spirit for query: "+name+"("+gui.Type.of(Type)+")")}})),function(){function maybespiritualize(elm){gui.mode!==gui.MODE_ROBOT&&gui.spiritualize(elm)}gui.DOMPlugin.mixin({appendTo:function(thing){var elm=this.spirit.element;return gui.Type.isSpirit(thing)?thing.dom.append(elm):gui.Type.isElement(thing)&&(thing.appendChild(elm),maybespiritualize(thing)),this},parseToNode:function(html,targetdoc){return gui.HTMLParser.parseToNode(html,targetdoc)},parseToNodes:function(html,targetdoc){return gui.HTMLParser.parseToNodes(html,targetdoc)}})}(),function(){function maybespiritualize(elm){gui.mode!==gui.MODE_ROBOT&&gui.spiritualize(elm)}gui.DOMPlugin.mixin(gui.Object.map({append:function(things){var els=things,element=this.spirit.element;els.forEach(function(el){element.appendChild(el),maybespiritualize(el)})},prepend:function(things){var els=things,element=this.spirit.element,first=element.firstChild;els.reverse().forEach(function(el){element.insertBefore(el,first),maybespiritualize(el)})},before:function(things){var els=things,target=this.spirit.element,parent=target.parentNode;els.reverse().forEach(function(el){parent.insertBefore(el,target),maybespiritualize(el)})},after:function(things){var els=things,target=this.spirit.element,parent=target.parentNode;els.forEach(function(el){parent.insertBefore(el,target.nextSibling),maybespiritualize(el)})},replace:function(things){this.after(things),this.remove()}},function(name,base){return function(things){var elms=Array.map(gui.Array.make(things),function(thing){return thing&&thing instanceof gui.Spirit?thing.element:thing}).filter(function(thing){return thing&&gui.Type.isNumber(thing.nodeType)});return elms.length&&base.call(this,elms),things}}))}(),gui.EventPlugin=function(chained,guiArray,DOMPlugin,Interface,Type){return gui.TrackerPlugin.extend({add:chained(function(arg,target,handler,capture){if(target=this._getelementtarget(target),!target.nodeType&&!Type.isWindow(target))throw new TypeError("Invalid target: "+target+" ("+this.spirit.$classname+")");if(handler=handler?handler:this.spirit,capture=capture?capture:!1,Interface.validate(gui.IEventHandler,handler)){var checks=[target,handler,capture];this._breakdown(arg).forEach(function(type){this._addchecks(type,checks)&&this._shiftEventListener(!0,target,type,handler,capture)},this)}}),remove:chained(function(arg,target,handler,capture){if(target=this._getelementtarget(target),!target.nodeType&&!Type.isWindow(target))throw new TypeError("Invalid target: "+target+" ("+this.spirit.$classname+")");if(handler=handler?handler:this.spirit,capture=capture?capture:!1,Interface.validate(gui.IEventHandler,handler)){var checks=[target,handler,capture];this._breakdown(arg).forEach(function(type){this._removechecks(type,checks)&&this._shiftEventListener(!1,target,type,handler,capture)},this)}}),toggle:chained(function(arg,target,handler,capture){target=this._getelementtarget(target),handler=handler?handler:this.spirit,capture=capture?capture:!1,target instanceof gui.Spirit&&(target=target.element);var checks=[target,handler,capture];guiArray.make(arg).forEach(function(type){this._contains(type,checks)?this.add(type,target,handler,capture):this.remove(type,target,handler,capture)},this)}),dispatch:function(type,params){var elm=this.spirit.element,evt=null;return window.CustomEvent&&!gui.Client.isExplorer?evt=new CustomEvent(type,params):(params=params||{bubbles:!1,cancelable:!1,detail:void 0},evt=document.createEvent("HTMLEvents"),evt.initEvent(type,params.bubbles,params.cancelable)),evt.eventName=type,elm.dispatchEvent?elm.dispatchEvent(evt):elm[type]?elm[type]():elm["on"+type]?elm["on"+type]():void 0;
},handleEvent:function(e){var related=e.relatedTarget,element=this.spirit.element,inorout=related&&related!==element&&!DOMPlugin.contains(element,related);switch(e.type){case"mouseover":inorout&&this._mouseenter&&this.spirit.onevent(this._getfakeevent(e,"mouseenter"));break;case"mouseout":inorout&&this._mouseleave&&this.spirit.onevent(this._getfakeevent(e,"mouseleave"))}},_mouseenter:!1,_mouseleave:!1,_shiftEventListener:function(add,target,type,handler,capture){var action=add?"addEventListener":"removeEventListener";target[action](type,handler,capture)},_enterleavetype:function(add,type,handler){var spirit=this.spirit;if(handler!==spirit)throw new TypeError(type+" not (yet) supported on "+handler);switch(type){case"mouseenter":return this._mouseenter=add,"mouseover";case"mouseleave":return this._mouseleave=add,"mouseout"}},_getelementtarget:function(target){return target=target?target:this.spirit.element,target instanceof gui.Spirit?target.element:target},_getfakeevent:function(realevent,newtype){var prop,fakeevent=Object.create(null);for(prop in realevent)fakeevent[prop]=realevent[prop],fakeevent.type=newtype;return fakeevent},_cleanup:function(type,checks){var target=checks[0],handler=checks[1],capture=checks[2];this.remove(type,target,handler,capture)},_breakdown:function(arg){return guiArray.make(arg).map(function(type){return"transitionend"===type?this._transitionend():type},this)},_transitionend:function(){var t,el=document.createElement("div"),transitions={transition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(t in transitions)if(void 0!==el.style[t])return transitions[t]}})}(gui.Combo.chained,gui.Array,gui.DOMPlugin,gui.Interface,gui.Type),gui.IEventHandler={toString:function(){return"[object IEventHandler]"},handleEvent:function(e){},onevent:function(e){}},gui.SpritePlugin=gui.Plugin.extend({x:{getter:function(){return this._pos.x},setter:function(x){this._pos.x=x,this._apply()}},y:{getter:function(){return this._pos.y},setter:function(y){this._pos.y=y,this._apply()}},z:{getter:function(){return this._pos.z},setter:function(z){this._pos.z=z,this._apply()}},onconstruct:function(){gui.Plugin.prototype.onconstruct.call(this),this._pos=new gui.Position},reset:function(){this.spirit.css.set("-beta-transform","")},_pos:null,_apply:function(){var pos=this._pos,set=[pos.x,pos.y,pos.z].map(Math.round);this.spirit.css.set("-beta-transform","translate3d("+set.join("px,")+"px)")}}),gui.Spirit=gui.Class.create(Object.prototype,{element:null,document:document,window:window,toString:function(){return"[object gui.Spirit]"},exorcise:function(){this.life.destructed||(gui.Spirit.$destruct(this),gui.Spirit.$dispose(this))},onconstruct:function(){},onconfigure:function(){},onenter:function(){},onattach:function(){},onready:function(){},oninit:function(){},ondetach:function(){},onexit:function(){},ondestruct:function(){},onasync:function(){},oncrawler:function(crawler){},$instanceid:null,$contextid:null,$destructed:!1,$onconstruct:function(elm){this.$contextid=gui.$contextid,this.element=elm,this.document=document,this.window=window,gui.Spirit.$construct(this)},$ondestruct:function(){},$pluginplugins:function(){var Plugin,plugins=this.constructor.$plugins;this.life=new gui.LifePlugin(this),this.config=new gui.ConfigPlugin(this),Object.keys(plugins).filter(function(prefix){return"life"!==prefix&&"config"!==prefix}).sort().forEach(function(prefix){Plugin=plugins[prefix],(this.life.plugins[prefix]=!Plugin.lazy)?gui.Plugin.$assign(this,prefix,new Plugin(this)):gui.Plugin.$prepare(this,prefix,Plugin)},this)},$debug:function(constructing){if(gui.debug){var val,elm=this.element,fix=gui.attributes[0];constructing?gui.attributes.every(function(f){return!elm.hasAttribute(f)})&&(val="["+this.constructor.$classname+"]",elm.setAttribute(fix,val)):(val=elm.getAttribute(fix),val&&val.startsWith("[")&&elm.removeAttribute(fix))}}},{portals:!0,summon:function(doc){return this.possess((doc||document).createElement("div"))},possess:function(element){return gui.Guide.$possess(element,this)},extend:function(){var C=gui.Class.extend.apply(this,arguments);return C.$plugins=gui.Object.copy(this.$plugins),C},plugin:function(prefix,plugin,override){var plugins=this.$plugins,proto=this.prototype;return!proto.hasOwnProperty(prefix)||null===proto.prefix||override?(!plugins[prefix]||override)&&(plugins[prefix]=plugin,proto.prefix=null,gui.Class.children(this,function(child){child.plugin(prefix,plugin,override)})):console.error("Plugin naming crash in "+this+": "+prefix),this},$plugins:Object.create(null)},{$construct:function(spirit){spirit.$pluginplugins(),spirit.$debug(!0),spirit.life.constructed=!0,spirit.onconstruct(),spirit.life.dispatch(gui.LIFE_CONSTRUCT)},$configure:function(spirit){spirit.config.configureall(),spirit.life.configured=!0,spirit.onconfigure(),spirit.life.dispatch(gui.LIFE_CONFIGURE)},$enter:function(spirit){gui.Guide.$inside(spirit),spirit.life.entered=!0,spirit.onenter(),spirit.life.dispatch(gui.LIFE_ENTER)},$attach:function(spirit){gui.Guide.$inside(spirit),spirit.life.attached=!0,spirit.onattach(),spirit.life.dispatch(gui.LIFE_ATTACH)},$ready:function(spirit){spirit.life.ready=!0,spirit.onready(),spirit.life.dispatch(gui.LIFE_READY)},$detach:function(spirit){gui.Guide.$outside(spirit),spirit.life.detached=!0,spirit.life.visible=!1,spirit.life.dispatch(gui.LIFE_DETACH),spirit.life.dispatch(gui.LIFE_INVISIBLE),spirit.ondetach()},$exit:function(spirit){spirit.life.exited=!0,spirit.life.dispatch(gui.LIFE_EXIT),spirit.onexit()},$async:function(spirit){spirit.life.async=!0,spirit.onasync(),spirit.life.dispatch(gui.LIFE_ASYNC)},$destruct:function(spirit){spirit.$debug(!1),spirit.life.destructed=!0,spirit.life.dispatch(gui.LIFE_DESTRUCT),spirit.ondestruct()},$dispose:function(spirit){spirit.$ondestruct(),spirit.$destructed=!0,gui.Guide.$forget(spirit),gui.Garbage.$collect(spirit)},$oninit:function(spirit){spirit.life.initialized=!0,spirit.life.dispatch("life-initialized"),spirit.oninit()},$reflex:function(source){new gui.Crawler(gui.CRAWLER_REFLEX).descend(source,{handleSpirit:function(spirit){spirit.reflex()}})}}),gui.DocumentSpirit=gui.Spirit.extend({onready:function(){gui.Spirit.prototype.onready.call(this),(this.waiting=gui.hosted)&&this.action.addGlobal(gui.$ACTION_XFRAME_VISIBILITY),this.action.dispatchGlobal(gui.ACTION_DOC_ONSPIRITUALIZED),this.broadcast.addGlobal(gui.BROADCAST_RESIZE_END)},onaction:function(a){switch(gui.Spirit.prototype.onaction.call(this,a),this.action.$handleownaction=!1,a.type){case gui.$ACTION_XFRAME_VISIBILITY:this._waiting=!1,gui.hasModule("gui-layout@wunderbyte.com")&&(a.data===!0?this.visibility.on():this.visibility.off()),a.consume()}},onbroadcast:function(b){gui.Spirit.prototype.onbroadcast.call(this,b),b.type===gui.BROADCAST_RESIZE_END},oncrawler:function(crawler){var dir=gui.Spirit.prototype.oncrawler.call(this,crawler);if(dir===gui.Crawler.CONTINUE)switch(crawler.type){case gui.CRAWLER_VISIBLE:case gui.CRAWLER_INVISIBLE:this._waiting&&(dir=gui.Crawler.STOP)}return dir},onvisible:function(){this.css.remove(gui.CLASS_INVISIBLE),gui.Spirit.prototype.onvisible.call(this)},oninvisible:function(){this.css.add(gui.CLASS_INVISIBLE),gui.Spirit.prototype.oninvisible.call(this)},_loaded:!1,_waiting:!1,_timeout:null}),gui.IframeSpirit=gui.Spirit.extend({spiritualized:!1,fit:!1,xguest:null,contentWindow:{getter:function(){return this.element.contentWindow}},contentDocument:{getter:function(){return this.element.contentDocument}},contentLocation:null,onconstruct:function(){gui.Spirit.prototype.onconstruct.call(this),this.event.add("message",window),this._postbox=[]},onenter:function(){gui.Spirit.prototype.onenter.call(this),this.event.add("load"),this.action.addGlobal([gui.ACTION_DOC_ONDOMCONTENT,gui.ACTION_DOC_ONLOAD,gui.ACTION_DOC_ONHASH,gui.ACTION_DOC_ONSPIRITUALIZED,gui.ACTION_DOC_UNLOAD]),this.fit&&(this.css.height=0);var src=this.element.src;src&&src!==gui.IframeSpirit.SRC_DEFAULT&&(src.startsWith("blob:")||this._setupsrc(src))},onaction:function(a){gui.Spirit.prototype.onaction.call(this,a),this.action.$handleownaction=!1;var base;switch(a.type){case gui.ACTION_DOC_ONDOMCONTENT:this.contentLocation=new gui.URL(document,a.data),this.life.dispatch(gui.LIFE_IFRAME_DOMCONTENT),this.action.remove(a.type),a.consume();break;case gui.ACTION_DOC_ONLOAD:this.contentLocation=new gui.URL(document,a.data),this.life.dispatch(gui.LIFE_IFRAME_ONLOAD),this.action.remove(a.type),a.consume();break;case gui.ACTION_DOC_ONHASH:base=this.contentLocation.href.split("#")[0],this.contentLocation=new gui.URL(document,base+a.data),this.life.dispatch(gui.LIFE_IFRAME_ONHASH),a.consume();break;case gui.ACTION_DOC_ONSPIRITUALIZED:this._onspiritualized(),this.life.dispatch(gui.LIFE_IFRAME_SPIRITUALIZED),this.action.remove(a.type),a.consume();break;case gui.ACTION_DOC_UNLOAD:this._onunload(),this.life.dispatch(gui.LIFE_IFRAME_UNLOAD),this.action.add([gui.ACTION_DOC_ONCONSTRUCT,gui.ACTION_DOC_ONDOMCONTENT,gui.ACTION_DOC_ONLOAD,gui.ACTION_DOC_ONSPIRITUALIZED]),a.consume()}},onevent:function(e){switch(gui.Spirit.prototype.onevent.call(this,e),e.type){case"message":this._onmessage(e.data,e.origin,e.source);break;case"load":}},onvisible:function(){gui.Spirit.prototype.onvisible.call(this),this.spiritualized&&this._visibility()},oninvisible:function(){gui.Spirit.prototype.oninvisible.call(this),this.spiritualized&&this._visibility()},src:function(src){return src&&(this._setupsrc(src),this.element.src=src),this.element.src},url:function(url,src){return src&&this._setupsrc(src),url&&(this.element.src=url),this.contentLocation.href},postMessage:function(msg){this.spiritualized?this.contentWindow.postMessage(msg,"*"):this._postbox.push(msg)},_setupsrc:function(src){var doc=document;this.contentLocation=new gui.URL(doc,src),this.xguest=function(secured){if(secured)return"*";if(gui.URL.external(src,doc)){var url=new gui.URL(doc,src);return url.protocol+"//"+url.host}return null}(this._sandboxed())},_onspiritualized:function(){for(this.spiritualized=!0;this._postbox.length;)this.postMessage(this._postbox.shift());this._visibility()},_onfit:function(height){this.fit&&(this.css.height=height,this.action.dispatchGlobal(gui.ACTION_DOC_FIT))},_onunload:function(){this.spiritualized=!1,this.fit&&(this.css.height=0)},_onmessage:function(msg,origin,source){if(source===this.contentWindow&&msg.startsWith("spiritual-action:")){var a=gui.Action.parse(msg);a.direction===gui.Action.ASCEND&&(this.action.$handleownaction=!0,this.action.ascendGlobal(a.type,a.data))}},_sandboxed:function(){var sandbox=this.element.sandbox;return sandbox&&sandbox.length},_visibility:function(){gui.hasModule("gui-layout@wunderbyte.com")&&gui.Type.isDefined(this.life.visible)&&this.action.descendGlobal(gui.$ACTION_XFRAME_VISIBILITY,this.life.visible)}},{summon:function(doc,src){var iframe=doc.createElement("iframe"),spirit=this.possess(iframe);if(spirit.css.add("gui-iframe"),src){if(gui.URL.external(src,doc)){var url=new gui.URL(doc,src);spirit.xguest=url.protocol+"//"+url.host}}else src=this.SRC_DEFAULT;return iframe.src=src,spirit}},{SRC_DEFAULT:"javascript:void(false);"}),gui.Position=function(x,y,z){this.x=x||0,this.y=y||0,this.z=z||0},gui.Position.prototype={x:0,y:0,z:0,toString:function(){return"[object gui.Position]"},clone:function(){return new gui.Position(this.x,this.y,this.z)}},gui.Position.isEqual=function(p1,p2){return p1.x===p2.x&&p1.y===p2.y},gui.Dimension=function(w,h){this.w=w||0,this.h=h||0},gui.Dimension.prototype={w:0,h:0,toString:function(){return"[object gui.Dimension]"}},gui.Dimension.isEqual=function(dim1,dim2){return dim1.w===dim2.w&&dim1.h===dim2.h},gui.Geometry=function(x,y,w,h){this.x=x||0,this.y=y||0,this.w=w||0,this.h=h||0},gui.Geometry.prototype={x:0,y:0,w:0,h:0,toString:function(){return"[object gui.Geometry]"},hitTest:function(geo){return gui.Geometry.hitTest(this,geo)}},gui.Geometry.isEqual=function(geo1,geo2){return geo1.x===geo2.x&&geo1.y===geo2.y&&geo1.w===geo2.w&&geo1.h===geo2.h},gui.Geometry.hitTest=function(geo1,geo2){function x(g1,g2){return g1.x>=g2.x&&g1.x<=g2.x+g2.w}function y(g1,g2){return g1.y>=g2.y&&g1.y<=g2.y+g2.h}var hitx=x(geo1,geo2)||x(geo2,geo1),hity=y(geo1,geo2)||y(geo2,geo1);return hitx&&hity},gui.DOMChanger={init:function(){var proto=Element.prototype;if(gui.Type.isDefined(proto.spirit))throw new Error("Spiritual loaded twice?");proto.spirit=null},change:function(){var Elm=gui.Client.isExplorer?HTMLElement:Element;this._change(Elm.prototype,gui.DOMCombos)},_change:function(proto,combos){var root=document.documentElement;gui.Object.each(combos,function(name,combo){this._docombo(proto,name,combo,root)},this)},_docombo:function(proto,name,combo,root){this._ismethod(name)?this._domethod(proto,name,combo):gui.Client.isGecko?this._dogeckoaccessor(proto,name,combo,root):gui.Client.isExplorer&&this._doieaccessor(proto,name,combo)},_ismethod:function(name){var is=!1;switch(name){case"appendChild":case"removeChild":case"insertBefore":case"replaceChild":case"setAttribute":case"removeAttribute":case"insertAdjecantHTML":is=!0}return is},_domethod:function(proto,name,combo){var base=proto[name];proto[name]=combo(function(){return base.apply(this,arguments)})},_doieaccessor:function(proto,name,combo){var base=Object.getOwnPropertyDescriptor(proto,name);base&&Object.defineProperty(proto,name,{enumerable:!0,configurable:!0,get:function(){return base.get.call(this)},set:combo(function(value){base.set.call(this,value)})})},_dogeckoaccessor:function(proto,name,combo,root){var getter=root.__lookupGetter__(name),setter=root.__lookupSetter__(name);getter&&(proto.__defineGetter__(name,function(){return getter.apply(this,arguments)}),proto.__defineSetter__(name,combo(function(){setter.apply(this,arguments)})))}},gui.DOMCombos=function(before,after,around,provided,Type,DOMPlugin,DOMObserver,guiArray){var ifEmbedded=provided(function(){return DOMPlugin.embedded(this)}),ifSpirit=provided(function(){var spirit=gui.get(this);return spirit&&!spirit.$destructed}),spiritualizeAfter=around(function(action,node){var contents;if(Type.isDocumentFragment(node)&&(contents=guiArray.from(node.childNodes)),action(),Type.isDocumentFragment(node))for(var i=0,len=contents.length;len>i;i++)gui.spiritualize(contents[i]);else gui.spiritualize(node)}),materializeOldBefore=before(function(newnode,oldnode){gui.materialize(oldnode)}),detachBefore=before(function(node){gui.Guide.$detach(node)}),setAttBefore=before(function(name,value){this.spirit.att.set(name,value)}),delAttBefore=before(function(name){this.spirit.att.del(name)}),suspending=around(function(action){return gui.DOMObserver.observes?gui.DOMObserver.suspend(function(){return action()}):action()}),materializeSubBefore=before(function(){gui.materializeSub(this)}),spiritualizeSubAfter=after(function(){gui.spiritualizeSub(this)}),parent=null,materializeThisBefore=before(function(){parent=this.parentNode,gui.materialize(this)}),spiritualizeParentAfter=after(function(){gui.spiritualize(parent)}),spiritualizeAdjecantAfter=after(function(position,html){switch(position){case"beforebegin":console.warn("TODO: Spiritualize previous siblings");break;case"afterbegin":console.warn("TODO: Spiritualize first children");break;case"beforeend":console.warn("TODO: Spiritualize last children");break;case"afterend":console.warn("TODO: Spiritualize following children")}}),ifEnabled=provided(function(){var win=this.ownerDocument.defaultView;return win?win.gui.mode!==gui.MODE_HUMAN:!1}),ifSerious=provided(function(){var win=this.ownerDocument.defaultView;return win?win.gui.mode!==gui.MODE_FUNNY:!1}),otherwise=function(action){return action};return{appendChild:function(base){return ifEnabled(ifSerious(ifEmbedded(spiritualizeAfter(suspending(base)),otherwise(base)),otherwise(base)),otherwise(base))},insertBefore:function(base){return ifEnabled(ifSerious(ifEmbedded(spiritualizeAfter(suspending(base)),otherwise(base)),otherwise(base)),otherwise(base))},replaceChild:function(base){return ifEnabled(ifEmbedded(materializeOldBefore(ifSerious(spiritualizeAfter(suspending(base)),otherwise(suspending(base)))),otherwise(base)),otherwise(base))},insertAdjecantHTML:function(base){return ifEnabled(ifEmbedded(ifSerious(spiritualizeAdjecantAfter(suspending(base)),otherwise(suspending(base)))),otherwise(base)),otherwise(base)},removeChild:function(base){return ifEnabled(ifEmbedded(detachBefore(suspending(base)),otherwise(base)),otherwise(base))},setAttribute:function(base){return ifEnabled(ifEmbedded(ifSpirit(setAttBefore(base),otherwise(base)),otherwise(base)),otherwise(base))},removeAttribute:function(base){return ifEnabled(ifEmbedded(ifSpirit(delAttBefore(base),otherwise(base)),otherwise(base)),otherwise(base))},innerHTML:function(base){return ifEnabled(ifEmbedded(materializeSubBefore(spiritualizeSubAfter(suspending(base))),otherwise(base)),otherwise(base))},outerHTML:function(base){return ifEnabled(ifEmbedded(materializeThisBefore(spiritualizeParentAfter(suspending(base))),otherwise(base)),otherwise(base))},textContent:function(base){return ifEnabled(ifEmbedded(materializeSubBefore(suspending(base)),otherwise(base)),otherwise(base))}}}(gui.Combo.before,gui.Combo.after,gui.Combo.around,gui.Combo.provided,gui.Type,gui.DOMPlugin,gui.DOMObserver,gui.Array),gui.DOMObserver={observes:!1,observe:function(){if(!gui.Client.hasMutations)throw new Error("MutationObserver no such thing");if(!this._observer){var Observer=this._mutationobserver(),MeMyself=gui.DOMObserver;this._observer=new Observer(function(mutations){mutations.forEach(function(mutation){MeMyself._handleMutation(mutation)})})}this._connect(!0),this.observes=!0},suspend:function(action,thisp){var res;return this.observes&&1===++this._suspend&&this._connect(!1),gui.Type.isFunction(action)&&(res=action.call(thisp)),this.observes&&this.resume(),res},resume:function(){this.observes&&0===--this._suspend&&this._connect(!0)},_suspend:0,_observer:null,_mutationobserver:function(){return window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver},_connect:function(connect){var obs=this._observer;obs&&(connect?obs.observe(document,{childList:!0,subtree:!0}):obs.disconnect())},_handleMutation:function(mutation){var webkithack=!0;Array.forEach(mutation.removedNodes,function(node){node.nodeType===Node.ELEMENT_NODE&&gui.materialize(node,webkithack)},this),Array.forEach(mutation.addedNodes,function(node){node.nodeType===Node.ELEMENT_NODE&&gui.spiritualize(node)},this)}},gui.Assistant=function(Crawler){return{$possess:function(elm,Spirit){if(elm.spirit)throw new Error("Cannot repossess element with spirit "+elm.spirit+" (exorcise first)");if(gui.debug&&!gui.Type.isSpiritConstructor(Spirit))throw new Error("Not a spirit constructor ("+gui.Type.of(Spirit)+")");return elm.spirit=new Spirit(elm),elm.spirit},$maybepossess:function(elm,channels){var hit;return elm.spirit||(hit=this._maybepossess(elm,channels))&&this.$possess(elm,hit),elm.spirit},$detectspirits:function(element,skip,one,channels){var spirit,spirits=[],Assistant=this;return new Crawler(gui.CRAWLER_SPIRITUALIZE).descend(element,{handleElement:function(elm){if(skip&&elm===element||(spirit=elm.spirit,spirit||(spirit=Assistant.$maybepossess(elm,channels)),spirit&&(spirit.life.attached||spirits.push(spirit))),one)return Crawler.SKIP_CHILDREN;if(!elm.childElementCount)return Crawler.SKIP_CHILDREN;if(elm.hasAttribute("tempname"))return Crawler.SKIP_CHILDREN;switch(elm.localName){case"pre":case"code":return Crawler.SKIP_CHILDREN}return Crawler.CONTINUE}}),spirits},_maybepossess:function(elm,channels){var res=null;return elm.nodeType===Node.ELEMENT_NODE&&gui.attributes.every(function(fix){return res=this._maybepossessinline(elm,fix),null===res},this)&&channels&&channels.every(function(def){var select=def[0],spirit=def[1];return gui.CSSPlugin.matches(elm,select)&&(res=spirit),null===res},this),res},_maybepossessinline:function(elm,fix){var res=null,att=elm.getAttribute(fix);return gui.Type.isString(att)&&!att.startsWith("[")&&(""!==att?(res=gui.Object.lookup(att),res||console.error(att+" is not defined.")):res=!1),res}}}(gui.Crawler),gui.Guide=function(Assistant,Type,guiArray,Broadcast,DOMPlugin,Spirit,Tick,Crawler){var documentspirits={incoming:[],inside:Object.create(null),outside:Object.create(null)};return{toString:function(){return"[object gui.Guide]"},suspend:function(operation,thisp){this._suspended=!0;var res=operation.call(thisp);return this._suspended=!1,res},$startGuiding:function(){this._startGuiding(),Broadcast.dispatch(gui.BROADCAST_WILL_SPIRITUALIZE),this._spiritualizeinitially(),Broadcast.dispatch(gui.BROADCAST_DID_SPIRITUALIZE)},$possess:function(elm,Spirit){return Assistant.$possess(elm,Spirit)},$spiritualize:function(target){target=Type.isSpirit(target)?target.element:target,this._maybespiritualize(target,!1,!1)},$spiritualizeSub:function(target){this._maybespiritualize(target,!0,!1)},$spiritualizeOne:function(target){this._maybespiritualize(target,!1,!0)},$materialize:function(target,webkithack){this._maybematerialize(target,!1,!1,webkithack)},$materializeSub:function(target){this._maybematerialize(target,!0,!1)},$materializeOne:function(target){this._maybematerialize(target,!1,!0)},$detach:function(target){this._maybedetach(target)},$forget:function(spirit){var spirits=documentspirits,key=spirit.$instanceid;delete spirits.inside[key],delete spirits.outside[key],this._stoptracking(spirit)},$channel:function(){switch(Type.of(arguments[0])){case"string":this._channelOne.apply(this,arguments);break;case"array":this._channelAll.apply(this,arguments)}},$hasChannels:function(){return this._channels&&this._channels.length},$getChannels:function(){return this._channels.slice()},$debug:function(){console.log(this._channels.reduce(function(log,channel){return log+"\n\n"+channel[0]+" : "+channel[1]},location.href))},$inside:function(spirit){var spirits=documentspirits,key=spirit.$instanceid;spirits.inside[key]||(spirits.outside[key]&&delete spirits.outside[key],spirits.inside[key]=spirit,spirits.incoming.push(spirit),Tick.dispatch(gui.$TICK_INSIDE,4))},$outside:function(spirit){var spirits=documentspirits,key=spirit.$instanceid;spirits.outside[key]||(spirits.inside[key]&&(delete spirits.inside[key],this._stoptracking(spirit)),spirits.outside[key]=spirit,Tick.dispatch(gui.$TICK_OUTSIDE,0))},$goasync:function(spirits){if(spirits.forEach(function(spirit){Spirit.$async(spirit)}),gui.hosted){var docspirit=gui.get("html");if(void 0===docspirit.life.visible)return}this._visibility(spirits)},$getSpiritById:function(key){return documentspirits.inside[key]||null},_arrivals:Object.create(null),_channels:[],_todochannels:null,_suspended:!1,_startGuiding:function(){var ticks=[gui.$TICK_INSIDE,gui.$TICK_OUTSIDE];gui.Tick.add(ticks,{ontick:function(tick){tick.type===ticks[0]?gui.Guide._updateincoming():gui.Guide._updateoutside()}}),this._todochannels&&(this._channelAll(this._todochannels),this._todochannels=null)},_spiritualizeinitially:function(){var root=document.documentElement;gui.DOMChanger.init(),this.$spiritualizeOne(root),gui.mode===gui.MODE_ROBOT&&(gui.DOMChanger.change(),gui.Client.isWebKit&&gui.DOMObserver.observe(),this.$spiritualizeSub(root))},_handles:function(node,webkithack){return node&&!this._suspended&&(webkithack||DOMPlugin.embedded(node))&&Type.isElement(node)},_collect:function(node,skip,id){var list=[];return new Crawler(id).descend(node,{handleSpirit:function(spirit){skip&&spirit.element===node||spirit.life.destructed||list.push(spirit)}}),list},_maybespiritualize:function(node,skip,one){node=Type.isSpirit(node)?node.element:node,node=Type.isDocument(node)?node.documentElement:node,this._handles(node)&&this._spiritualize(node,skip,one)},_spiritualize:function(elm,skip,one){var spirits,channels=this._channels;skip=!1,spirits=Assistant.$detectspirits(elm,skip,one,channels),this._sequence(spirits)},_sequence:function(){function configure(spirit){return spirit.life.configured||Spirit.$configure(spirit),spirit}function enter(spirit){return spirit.life.entered||Spirit.$enter(spirit),spirit}function attach(spirit){return Spirit.$attach(spirit),spirit}function ready(spirit){spirit.life.ready||Spirit.$ready(spirit)}return function(spirits){spirits.map(configure).map(enter).map(attach).reverse().forEach(ready)}}(),_maybematerialize:function(node,skip,one,force,webkithack){node=Type.isSpirit(node)?node.element:node,node=Type.isDocument(node)?node.documentElement:node,(force||this._handles(node,webkithack))&&(node.setAttribute("gui-matarializing","true"),this._materialize(node,skip,one),node.removeAttribute("gui-matarializing"))},_materialize:function(element,skip,one){this._collect(element,skip,gui.CRAWLER_MATERIALIZE).reverse().filter(function(spirit){return spirit.life.attached&&!spirit.life.destructed?(Spirit.$destruct(spirit),!0):!1}).forEach(function(spirit){Spirit.$dispose(spirit)})},_maybedetach:function(element){element=Type.isSpirit(element)?element.element:element,this._handles(element)&&this._collect(element,!1,gui.CRAWLER_DETACH).forEach(function(spirit){Spirit.$detach(spirit)})},_channelOne:function(select,klass){var spirit;gui.initialized?(spirit="string"==typeof klass?gui.Object.lookup(klass):klass,!gui.debug||Type.isSpiritConstructor(spirit)?this._channels.unshift([select,spirit]):console.error('Bad spirit for selector "'+select+'": '+spirit)):(this._todochannels=this._todochannels||[],this._todochannels.push([select,klass]))},_channelAll:function(channels){gui.initialized?channels.forEach(function(c){this._channelOne(c[0],c[1])},this):(this._todochannels=this._todochannels||[],this._todochannels=this._todochannels.concat(channels.reverse()))},_stoptracking:function(spirit){var incoming=documentspirits.incoming;if(incoming.length){var i=incoming.indexOf(spirit);i>-1&&guiArray.remove(incoming,i)}},_updateincoming:function(){gui.Guide.$goasync(documentspirits.incoming),documentspirits.incoming=[]},_updateoutside:function(){var outside=documentspirits.outside,spirits=gui.Object.each(outside,function(key,spirit){return spirit});spirits.forEach(function(spirit){Spirit.$destruct(spirit)}),spirits.forEach(function(spirit){Spirit.$dispose(spirit)}),documentspirits.outside=Object.create(null)},_visibility:function(spirits){gui.hasModule("gui-layout@wunderbyte.com")&&DOMPlugin.group(spirits).forEach(function(spirit){gui.VisibilityPlugin.$init(spirit)},this)}}}(gui.Assistant,gui.Type,gui.Array,gui.Broadcast,gui.DOMPlugin,gui.Spirit,gui.Tick,gui.Crawler),gui.Module.mixin({onbeforespiritualize:function(){},onafterspiritualize:function(){},$onconstruct:function(name){this.$modname=name,gui.Module.$init(this),this.toString=function(){return"[module "+name+"]"}}},{},{$init:function(module){gui.Type.isObject(module.mixin)&&gui.Spirit.mixin(module.mixin),gui.Type.isArray(module.channel)&&gui.channel(module.channel),gui.Type.isObject(module.plugin)&&gui.Object.each(module.plugin,function(prefix,Plugin){gui.Type.isDefined(Plugin)?gui.Spirit.plugin(prefix,Plugin):console.error("Undefined plugin for prefix: "+prefix)})}}),function(modules){modules.forEach(gui.Module.$init)}(gui.Module._modules),function(modules){gui.Object.each({onbeforespiritualize:gui.BROADCAST_WILL_SPIRITUALIZE,onafterspiritualize:gui.BROADCAST_DID_SPIRITUALIZE},function(action,broadcast){gui.Broadcast.add(broadcast,{onbroadcast:function(){modules.forEach(function(module){module[action]()})}})})}(gui.Module._modules),gui.module("gui-spirits@wunderbyte.com",{channel:[["html",gui.DocumentSpirit],[".gui-iframe",gui.IframeSpirit],[".gui-spirit",gui.Spirit]],plugin:{"super":gui.SuperPlugin,action:gui.ActionPlugin,broadcast:gui.BroadcastPlugin,tick:gui.TickPlugin,att:gui.AttPlugin,config:gui.ConfigPlugin,box:gui.BoxPlugin,css:gui.CSSPlugin,dom:gui.DOMPlugin,event:gui.EventPlugin,life:gui.LifePlugin,sprite:gui.SpritePlugin},mixin:{onaction:function(action){},onbroadcast:function(broadcast){},ontick:function(tick){},onatt:function(att){},onevent:function(event){},onlife:function(life){},handleEvent:function(e){"webkitTransitionEnd"===e.type&&(e={type:"transitionend",target:e.target,propertyName:e.propertyName,elapsedTime:e.elapsedTime,pseudoElement:e.pseudoElement}),this.onevent(e)},$ondestruct:gui.Combo.before(function(){this.handleEvent=function(){}})(gui.Spirit.prototype.$ondestruct)}})}(self),function(window){"use strict";window.edb=gui.namespace("edb",function(confirmed){return{version:"-1.0.0",debug:!1,$accessaware:!1,BROADCAST_ACCESS:"edb-broadcast-access",BROADCAST_CHANGE:"edb-broadcast-change",BROADCAST_OUTPUT:"edb-broadcast-output",BROADCAST_SCRIPT_INVOKE:"edb-broadcast-script-invoke",TICK_SCRIPT_UPDATE:"edb-tick-script-update",TICK_COLLECT_INPUT:"edb-tick-collect-input",TICK_PUBLISH_CHANGES:"edb-tick-update-changes",get:function(){console.error("Deprecated API is deprecated: edb.get()")}}}(gui.Arguments.confirmed)),edb.Type=function(chained){return gui.Class.create(null,{onconstruct:function(){},ondestruct:function(){},output:chained(function(){edb.Output.$output(this)}),outputGlobal:chained(function(){console.error("Not supported just yet: "+this+".outputGlobal()")}),revoke:chained(function(){edb.Output.$revoke(this)}),dispose:chained(function(){edb.Type.$destruct(this)}),serializeToString:function(filter,tabs){return(new edb.Serializer).serializeToString(this,filter,tabs)},$originalid:null,$destructed:!1,$onconstruct:function(){},$ondestruct:function(){this.constructor.storage&&this.persist()}})}(gui.Combo.chained),edb.Type.mixin(null,null,{is:function(o){return edb.Object.is(o)||edb.Array.is(o)},isConstructor:function(o){return gui.Type.isGuiClass(o)&&gui.Class.ancestorsAndSelf(o).some(function(C){return C===edb.Object||C===edb.Array})},lookup:function(context,arg){var type=null;switch(gui.Type.of(arg)){case"function":type=arg;break;case"string":type=gui.Object.lookup(arg,context);break;case"object":console.error(this+": expected edb.Type constructor (not an object)")}if(!type)throw new TypeError('The type "'+arg+'" does not exist');return type},cast:function(value){if(gui.Type.isComplex(value)&&!edb.Type.is(value))switch(gui.Type.of(value)){case"object":return edb.Object.from(value);case"array":return edb.Array.from(value)}return value},mixin:function(protos,xstatics,statics){return[edb.Object,edb.Array].forEach(function(Type){Type.mixin(protos,xstatics,statics)}),this},$observe:function(type,handler){var id=type.$instanceid,obs=this._observers,handlers=obs[id]||(obs[id]=[]);return-1===handlers.indexOf(handler)&&handlers.push(handler),type},$unobserve:function(type,handler){var index,id=type.$instanceid,obs=this._observers,handlers=obs[id];return handlers&&(index=handlers.indexOf(handler))>-1&&0===gui.Array.remove(handlers,index)&&delete obs[id],type},$destruct:function(type){(new edb.Crawler).crawl(type,{ontype:function(t){t.$destructed||(type.ondestruct(),type.$ondestruct(),type.$destructed=!0,gui.unloading||gui.Garbage.$nukeallofit(type))}})}}),function(confirmed){var iomixins={isOutput:function(){return edb.Output.$is(this)},getOutput:function(){console.error("Deprecated API is deprecated: getOutput()")},revokeOutput:function(){console.error("Deprecated API is deprecated: revokeOutput()")}},spassermixins={from:gui.Arguments.confirmed("(string|object|array|null)")(function(json){var Type=this;return json&&(edb.Type.is(json)&&(json=(new edb.Serializer).serializeToString(json)),gui.Type.isString(json)&&(json.includes("$object")||json.includes("$array"))&&(json=(new edb.Parser).parseFromString(json,null))),new Type(json)}),extend:function(){var C=gui.Class.extend.apply(this,arguments);return C.output=new edb.Output(C),C}};[iomixins,spassermixins].forEach(function(mixins){gui.Object.each(mixins,function(key,value){edb.Type[key]=value})}),edb.Type.$staticmixins=function(){var mixins={};return[iomixins,spassermixins].forEach(function(set){Object.keys(set).forEach(function(key){mixins[key]=set[key]},this)},this),mixins}}(gui.Arguments.confirmed),edb.Object=function(confirmed,chained){return gui.Class.create(Object.prototype,{addObserver:confirmed("object|function")(chained(function(handler){
edb.Object.observe(this,handler)})),removeObserver:confirmed("object|function")(chained(function(handler){edb.Object.unobserve(this,handler)})),$onconstruct:function(json){switch(edb.Type.prototype.$onconstruct.apply(this,arguments),gui.Type.of(json)){case"object":case"undefined":case"null":var proxy=gui.Object.copy(json||{}),types=edb.ObjectPopulator.populate(proxy,this);edb.ObjectProxy.approximate(proxy,this,types);break;default:throw new TypeError("Unexpected edb.Object constructor argument of type "+gui.Type.of(json)+": "+String(json))}this.onconstruct(),this.oninit&&console.error("Deprecated API is deprecated: "+this+".oninit")},toJSON:function(){return gui.Object.map(this,function(key,value){var c=key.charAt(0);return"$"!==c&&"_"!==c?edb.Type.is(value)?value.toJSON():value:void 0})}})}(gui.Arguments.confirmed,gui.Combo.chained),edb.Object.mixin(null,edb.Type.$staticmixins(),{observe:edb.Type.$observe,unobserve:edb.Type.$unobserve,ontick:function(tick){var snapshot,changes,handlers,observers=this._observers;tick.type===edb.TICK_PUBLISH_CHANGES&&(snapshot=gui.Object.copy(this._changes),this._changes=Object.create(null),gui.Object.each(snapshot,function(instanceid,propdef){(handlers=observers[instanceid])&&(changes=[],gui.Object.each(snapshot,function(id,props){id===instanceid&&gui.Object.each(props,function(name,change){changes.push(change)})}),handlers.forEach(function(handler){handler.onchange(changes)}))}))},$onaccess:function(object,name){edb.$accessaware&&gui.Broadcast.dispatch(edb.BROADCAST_ACCESS,[object,name])},$onchange:function(object,name,oldval,newval){if(oldval!==newval){var type=edb.ObjectChange.TYPE_UPDATE,all=this._changes,id=object.$instanceid,set=all[id]=all[id]||(all[id]=Object.create(null));set[name]=new edb.ObjectChange(object,name,type,oldval,newval),gui.Tick.dispatch(edb.TICK_PUBLISH_CHANGES)}},_observers:Object.create(null),_changes:Object.create(null)}),function(){gui.Tick.add(edb.TICK_PUBLISH_CHANGES,edb.Object),gui.Object.extendmissing(edb.Object.prototype,edb.Type.prototype)}(),function(proto,chained){function convert(array,args){return edb.ArrayPopulator.convert(array,args)}function onchange(array,index,removed,added){edb.Array.$onchange(array,index,removed,added)}function observes(array){var key=array.$instanceid;return edb.Array._observers[key]?!0:!1}edb.Array=gui.Class.create(proto,{push:function(){var idx=this.length,add=convert(this,arguments),res=proto.push.apply(this,add);return observes(this)&&onchange(this,idx,null,add),res},pop:function(){var idx=this.length-1,res=proto.pop.apply(this);return observes(this)&&idx>=0&&onchange(this,idx,[res],null),res},shift:function(){var res=proto.shift.apply(this);return observes(this)&&onchange(this,0,[res],null),res},unshift:function(){var add=convert(this,arguments),res=proto.unshift.apply(this,add);return observes(this)&&onchange(this,0,null,add),res},splice:function(){var arg=arguments,idx=arg[0],add=convert(this,[].slice.call(arg,2)),fix=[idx,arg[1]].concat(add),out=proto.splice.apply(this,fix);return observes(this)&&onchange(this,idx,out,add),out},reverse:function(){if(observes(this)){var out=this.toJSON(),add=proto.reverse.apply(out.slice());onchange(this,0,out,add)}return proto.reverse.apply(this)},onconstruct:function(members){},addObserver:chained(function(handler){edb.Object.observe(this,handler),edb.Array.observe(this,handler)}),removeObserver:chained(function(handler){edb.Object.unobserve(this,handler),edb.Array.unobserve(this,handler)}),$of:null,$onconstruct:function(){var object,types;edb.Type.prototype.$onconstruct.apply(this,arguments),arguments.length&&(object=arguments[0]?arguments[0].$object||{}:{},types=edb.ObjectPopulator.populate(object,this),edb.ArrayPopulator.populate(this,arguments),edb.ObjectProxy.approximate(object,this,types)),this.onconstruct([].slice.call(this))},get:function(index){return edb.$accessaware&&edb.Array.$onaccess(this,index),this[index]},getLength:function(index){return edb.$accessaware&&edb.Array.$onaccess(this,index),this.length},setLength:function(length){for(var out=[];this.length>length;)out.push(this.pop());out.length&&onchange(this,this.length-1,out)},toJSON:function(){return Array.map(this,function(thing){return edb.Type.is(thing)?thing.toJSON():thing})}})}(Array.prototype,gui.Combo.chained),edb.Array.mixin(null,edb.Type.$staticmixins(),{observe:edb.Type.$observe,unobserve:edb.Type.$unobserve,isConstructor:function(o){return gui.Type.isConstructor(o)&&gui.Class.ancestorsAndSelf(o).indexOf(edb.Array)>-1},ontick:function(tick){var snapshot,handlers,observers=this._observers;tick.type===edb.TICK_PUBLISH_CHANGES&&(snapshot=gui.Object.copy(this._changes),this._changes=Object.create(null),gui.Object.each(snapshot,function(instanceid,changes){(handlers=observers[instanceid])&&handlers.forEach(function(handler){handler.onchange(changes)})}))},_observers:Object.create(null),_changes:Object.create(null),$onaccess:function(array,index){edb.$accessaware&&gui.Broadcast.dispatch(edb.BROADCAST_ACCESS,[array])},$onchange:function(array,index,removed,added){var key=array.$instanceid,all=this._changes,set=all[key]||(all[key]=[]);set.push(new edb.ArrayChange(array,index,removed,added)),gui.Tick.dispatch(edb.TICK_PUBLISH_CHANGES)}}),function(proto){function decorateAccess(proto,methods){methods.forEach(function(method){proto[method]=beforeaccess(proto[method])})}var beforeaccess=gui.Combo.before(function(){edb.$accessaware&&edb.Array.$onaccess(this,-1)});decorateAccess(proto,["filter","forEach","every","map","some","indexOf","lastIndexOf","slice"])}(edb.Array.prototype),function(){gui.Tick.add(edb.TICK_PUBLISH_CHANGES,edb.Array),gui.Object.extendmissing(edb.Array.prototype,edb.Type.prototype)}(),edb.ObjectPopulator=function(isdefined,iscomplex,isfunction,isconstructor){function definitions(handler){var Type=edb.Object.is(handler)?edb.Object:edb.Array,Base=edb.Object.is(handler)?Object:Array,keys=[],classes=[edb.Type,Type,Base];return gui.Object.all(handler,function(key){isregular(key)&&classes.every(function(o){return void 0===o.prototype[key]})&&keys.push(key)}),keys}function evalheaders(json,type){var id=json.$originalid||json.$instanceid;delete json.$instanceid,delete json.$originalid,id&&Object.defineProperty(type,"$originalid",gui.Property.nonenumerable({value:id}))}function faildefined(name,key){throw new TypeError(name+' declares "'+key+'" as something undefined')}function failconstructor(name,key){throw new TypeError(name+' "'+key+'" must resolve to a constructor')}function isregular(key){return key.match(/^[a-z]/i)}function lookupDescriptor(proto,key){return proto.hasOwnProperty(key)?Object.getOwnPropertyDescriptor(proto,key):(proto=Object.getPrototypeOf(proto))?lookupDescriptor(proto,key):null}return{populate:function(json,type){var Def,def,val,desc,types=Object.create(null),base=type.constructor.prototype,name=type.constructor.$classname,pure=[];return evalheaders(json,type),definitions(type).forEach(function(key){switch(def=type[key],val=json[key],def){case Object:type[key]={},pure.push(key);break;case Array:val&&Array.isArray(val)?type[key]=val.slice():type[key]=[],pure.push(key);break;default:isdefined(val)?isdefined(def)?iscomplex(def)&&(isfunction(def)?(isconstructor(def)||(def=def(val)),isconstructor(def)?null!==val&&(Def=def,types[key]=Def.from(json[key])):failconstructor(name,key)):types[key]=edb.Type.cast(isdefined(val)?val:def)):faildefined(name,key):isregular(key)&&edb.Type.isConstructor(def)?(edb.Array.isConstructor(def)?json[key]=[]:json[key]=null,Def=def,types[key]=Def.from(json[key])):(desc=lookupDescriptor(base,key))&&Object.defineProperty(json,key,desc)}}),gui.Object.nonmethods(json).filter(function(key){return-1===pure.indexOf(key)}).forEach(function(key){var def=json[key];isregular(key)&&gui.Type.isComplex(def)&&(types[key]||(types[key]=edb.Type.cast(def)))}),types}}}(gui.Type.isDefined,gui.Type.isComplex,gui.Type.isFunction,gui.Type.isConstructor),edb.ArrayPopulator=function(){function oflist(array){return array.$of&&array.$of.prototype.reverse}function islist(o){return Array.isArray(o)||edb.Array.is(o)}function constructas(Type,o){if(!gui.debug||edb.Type.isConstructor(Type)){if(!edb.Type.is(o))return new Type(o);if(Type.is(o))return o;fail(Type,o)}else fail("edb.Type",Type)}function filterfrom(filter,o){var t=filter(o);return gui.Type.isConstructor(t)?t=constructas(t,o):edb.Type.is(t)||null===t?t=t:fail("edb.Type constructor or instance",gui.Type.of(t),"return null for nothing"),t}function fail(expected,received,message){throw new TypeError("$of expected "+expected+", got "+received+(message?" ("+message+")":""))}function guidedconvert(args,array){return args.map(function(o){return void 0!==o&&(o=gui.Type.isConstructor(array.$of)?constructas(array.$of,o):filterfrom(function(x){return array.$of(x)},o)),o})}function autoconvert(args){return args.map(function(o){if(!edb.Type.is(o))switch(gui.Type.of(o)){case"object":return new edb.Object(o);case"array":return new edb.Array(o)}return o})}return{populate:function(array,args){var first=args[0];first&&(!oflist(array)&&islist(first)&&(args=first),Array.prototype.push.apply(array,this.convert(array,args)))},convert:function(array,args){if(args=gui.Array.from(args),gui.Type.isNull(array.$of))return autoconvert(args);if(gui.Type.isFunction(array.$of))return guidedconvert(args,array);var type=gui.Type.of(array.$of);throw new Error(array+" cannot be $of "+type)}}}(),edb.ObjectProxy=function(){function getter(key,base){return function(){var result=base.apply(this);return edb.$accessaware&&!suspend&&edb.Object.$onaccess(this,key),result}}function setter(key,base){return function(newval){suspend=!0;var oldval=this[key];base.apply(this,arguments),(newval=this[key])!==oldval&&edb.Object.$onchange(this,key,oldval,newval),suspend=!1}}var suspend=!1;return{approximate:function(target,handler,types){gui.Object.nonmethods(target).forEach(function(key){var desc=Object.getOwnPropertyDescriptor(target,key);desc.configurable&&Object.defineProperty(handler,key,{enumerable:desc.enumerable,configurable:desc.configurable,get:getter(key,function(){return desc.get?desc.get.call(this):types[key]||target[key]}),set:setter(key,function(value){var Type,type;if(desc.set)desc.set.call(this,value);else if(type=types[key])edb.Type.is(value)?types[key]=value:(Type=type.constructor,types[key]=Type.from(value));else{var oldval=target[key];Type=handler.constructor;var cast=Type.prototype[key];switch(cast){case Object:case Array:if(!gui.Type.isNull(value)&&!gui.Type.isComplex(value))throw new TypeError("Expected "+cast);target[key]=value,oldval!==value&&edb.Object.$onchange(handler,key,oldval,value);break;default:target[key]=edb.Type.cast(value)}}})})}),gui.Object.ownmethods(target).forEach(function(key){handler[key]=target[key]})}}}(),edb.Change=function(){},edb.Change.prototype={object:null,type:null},edb.ObjectChange=function(object,name,type,oldval,newval){this.object=object,this.name=name,this.type=type,this.oldValue=oldval,this.newValue=newval},edb.ObjectChange.prototype=gui.Object.create(edb.Change.prototype,{name:null,oldValue:void 0,newValue:void 0}),edb.ObjectChange.TYPE_UPDATE="update",edb.ArrayChange=function(array,index,removed,added){this.type=edb.ArrayChange.TYPE_SPLICE,this.object=array,this.index=index,this.removed=removed||[],this.added=added||[]},edb.ArrayChange.prototype=gui.Object.create(edb.Change.prototype,{index:-1,removed:null,added:null}),edb.ArrayChange.TYPE_SPLICE="splice",edb.ArrayChange.toSpliceParams=function(change){if(change.type===edb.ArrayChange.TYPE_SPLICE){var idx=change.index,out=change.removed.length,add=change.added;return[idx,out].concat(add)}throw new TypeError},edb.Output=function(chained){return gui.Class.create({get:function(){var input=edb.Output.$get(this._type);return input?input.data:null},revoke:chained(function(){edb.Output.$revoke(this._type)}),connect:chained(function(handler){edb.Input.$connect(this._type,handler)}),disconnect:chained(function(handler){edb.Input.$disconnect(this._type,handler)}),_type:null,$onconstruct:function(Type){this._type=Type},add:function(){return this.connect.apply(this,arguments)},remove:function(){return this.disconnect.apply(this,arguments)}},{},{$output:chained(function(type){var input=this._makeinput(type.constructor,type);gui.Broadcast.dispatch(edb.BROADCAST_OUTPUT,input)}),$revoke:chained(function(type){var Type=edb.Type.is(type)?type.constructor:type,nullinput=this._makeinput(Type,null);gui.Broadcast.dispatch(edb.BROADCAST_OUTPUT,nullinput),delete this._map[Type.$classid]}),$is:function(Type){if(Type){if(this._map){var classid=Type.$classid,typeobj=this._map[classid];return typeobj?!0:!1}return!1}throw new TypeError("No such Type")},$get:function(Type){if(Type){if(this._map){var classid=Type.$classid,typeobj=this._map[classid];return typeobj?new edb.Input(typeobj.constructor,typeobj):null}return null}throw new TypeError("No such Type")},_map:{},_makeinput:function(Type,type){var classid=Type.$classid;return this._map[classid]=type,new edb.Input(Type,type)}})}(gui.Combo.chained),edb.Input=function(chained,memoized,Interface,GuiType,GuiClass){var handlers=new gui.MapList;return gui.Class.create({type:null,data:null,revoked:!1,onconstruct:function(Type,type){if(!edb.Type.is(type)&&null!==type)throw new TypeError(type+" is not a Type instance");this.type=Type,this.data=type}},{},{IInputHandler:{oninput:function(i){},toString:function(){return"[interface InputHandler]"}},$connect:chained(function(Types,handler){Types=this.$breakdown(Types),Interface.validate(this.IInputHandler,handler)&&Types.every(this._check)&&this._add(Types,handler)}),$disconnect:chained(function(Types,handler){return Types=this.$breakdown(Types),Interface.validate(this.IInputHandler,handler)&&Types.every(this._check)&&this._remove(Types,handler),Types}),$breakdown:function(arg){return GuiType.isArray(arg)?this._breakarray(arg):this._breakother(arg)},$onoutput:function(input){var Type,type=input.data;null===type||handlers.each(function(classid,list){Type=GuiClass.get(classid),type instanceof Type&&list.slice().forEach(function(handler){handler.oninput(input)})})},$bestmatch:function(target,types,up){return this._bestmatch(target.$classid,types.map(function(type){return type.$classid}),up)},$rateall:function(target,types,up,action){types.forEach(function(type){action(type,this.$rateone(up?target:type,up?type:target))},this)},$rateone:function(target,type){return this._rateone(target.$classid,type.$classid)},_breakarray:function(array){return array.map(function(o){switch(GuiType.of(o)){case"function":return o;case"string":return gui.Object.lookup(o);case"object":console.error("Expected function. Got object.")}},this)},_breakother:function(arg){switch(GuiType.of(arg)){case"function":return[arg];case"string":return this._breakarray(arg.split(" "));case"object":console.error("Expected function. Got object.")}},_add:function(Types,handler){Types.filter(function(Type){return handlers.add(Type.$classid,handler)}).forEach(function(Type){GuiClass.descendantsAndSelf(Type,function(T){if(T.isOutput()){var input=edb.Output.$get(Type);handler.oninput(input)}},this)},this)},_remove:function(Types,handler){Types.forEach(function(Type){handlers.remove(Type.$classid,handler)})},_check:function(Type){if(!GuiType.isDefined(Type))throw new TypeError("Could not register input for undefined Type");return!0},_bestmatch:memoized(function(targetid,typeids,up){var best=null,rating=Number.MAX_VALUE,target=gui.Class.get(targetid),types=typeids.map(function(id){return gui.Class.get(id)});return this.$rateall(target,types,up,function(type,rate){rate>-1&&rating>rate&&(rating=rate,best=type)}),best}),_rateone:memoized(function(targetid,typeid){var target=gui.Class.get(targetid),type=gui.Class.get(typeid),r=0,rating=-1,parent=target;if(target===type)rating=0;else for(;parent=gui.Class.parent(parent);)r++,parent===type&&(parent=null,rating=r);return rating}),add:function(){console.error("Deprecated API is deprecated: edb.Input.add()")},remove:function(){console.error("Deprecated API is deprecated: edb.Input.remove()")},$add:function(){return console.warn("Deprecated API is deprecated: edb.Input.$add(). Use edb.Input.$connect()"),this.$connect.apply(this,arguments)},$remove:function(){return console.warn("Deprecated API is deprecated: edb.Input.$remove(). Use edb.Input.$disconnect()"),this.$disconnect.apply(this,arguments)}})}(gui.Combo.chained,gui.Combo.memoized,gui.Interface,gui.Type,gui.Class),function(){gui.Broadcast.add(edb.BROADCAST_OUTPUT,{onbroadcast:function(b){edb.Input.$onoutput(b.data)}})}(),edb.Crawler=function(){function Crawler(){}function crawl(type,handler){gui.Object.each(type,istype).forEach(function(type){handle(type,handler),crawl(type,handler)})}function istype(key,value){return edb.Type.is(value)?value:void 0}function handle(type,handler){handler.ontype&&handler.ontype(type),handler.onarray&&edb.Array.is(type)&&handler.onarray(type),handler.onobject&&edb.Object.is(type)&&handler.onobject(type)}return Crawler.prototype={crawl:function(type,handler){if(!edb.Type.is(type))throw new TypeError;handle(type,handler),crawl(type,handler)}},Crawler}(),edb.Serializer=function(){function Serializer(){}function isType(thing){return edb.Type.is(thing)}function isArray(type){return edb.Array.is(type)}function parse(type){return isArray(type)?asArray(type):asObject(type)}function asObject(type){var map=gui.Object.map(type,mapObject,type);return{$object:gui.Object.extend({$classname:type.$classname,$instanceid:type.$instanceid,$originalid:type.$originalid},map)}}function asArray(type){return gui.Object.extend(asObject(type),{$array:mapArray(type)})}function mapObject(key,value){var c=key.charAt(0);if("_"===c||"$"===c)return void 0;if(isArray(this)&&key.match(INTRINSIC))return void 0;if(isType(value))return parse(value);if(gui.Type.isComplex(value)){switch(value.constructor){case Object:case Array:return value}return void 0}if(isType(this)){var base=this.constructor.prototype,desc=Object.getOwnPropertyDescriptor(base,key);if(desc&&(desc.set||desc.get))return void 0}return value}function mapArray(type){return Array.map(type,function(thing){return isType(thing)?parse(thing):thing})}Serializer.prototype={serializeToString:function(type,filter,tabs){if(isType(type))return JSON.stringify(parse(type),filter,tabs);throw new TypeError("Expected edb.Object|edb.Array")}};var INTRINSIC=/^length|^\d+/;return Serializer}(),edb.Parser=function(){function Parser(){}function parse(json,type){var Type,name;if(null===type||(type?(name=type.$classname||name,Type=name?type:gui.Object.lookup(name)):(name=json.$object.$classname,Type=gui.Object.lookup(name))),json=mapValue(json),null===type)return json;if(Type)return Type.from(json);var error=new TypeError(name+" is not defined");throw name===gui.Class.ANONYMOUS&&console.error('TODO: Spiritual should make sure that nothing is ever "'+name+'"\n'+JSON.stringify(json,null,4)),error}function isType(json){return gui.Type.isComplex(json)&&(json.$array||json.$object)}function asObject(type){return gui.Object.map(type.$object,mapObject)}function asArray(type){var members=type.$array.map(mapValue);return members.$object=type.$object,members}function mapObject(key,value){switch(key){case"$classname":return void 0;default:return mapValue(value)}}function mapValue(value){return isType(value)?value.$array?asArray(value):asObject(value):value}return Parser.prototype={parseFromString:function(json,type){try{json=JSON.parse(json)}catch(JSONException){throw new TypeError("Bad JSON: "+JSONException.message)}finally{if(isType(json))return parse(json,type);throw new TypeError("Expected serialized edb.Object|edb.Array")}}},Parser}(),edb.InputPlugin=function(chained,Input){return gui.TrackerPlugin.extend({done:!0,onconstruct:function(){gui.TrackerPlugin.prototype.onconstruct.call(this),this._watches=[],this._matches=[],this._needing=[]},ondestruct:function(){gui.TrackerPlugin.prototype.ondestruct.call(this),this.remove(this._watches)},connect:chained(function(arg,handler,required){var Types=Input.$breakdown(arg);Types.length&&(this.done=this.done&&required===!1,Types.forEach(function(Type){this._addchecks(Type.$classid,[handler||this.spirit]),this._watches.push(Type),required&&this._needing.push(Type)},this),Input.$connect(Types,this))}),disconnect:chained(function(arg,handler){var Types=Input.$breakdown(arg);Types.length&&(Types.forEach(function(Type){this._removechecks(Type.$classid,[handler||this.spirit]),gui.Array.remove(this._watches,Type),gui.Array.remove(this._needing,Type)},this),Input.$disconnect(Types,this),this.done=this._done())}),one:function(){console.error("Not supported just yet: "+this+".one()")},get:function(Type){var types=this._matches.map(function(input){return input.data.constructor}),best=Input.$bestmatch(Type,types,!1),input=best?this._matches.filter(function(input){return input.type===best}).shift():null;return input?input.data:null},oninput:function(input){this.$oninput(input)},match:function(input){var needstesting=!this._matches.length;return needstesting||this._matches.every(function(match){return match.$instanceid!==input.$instanceid})?this._maybeinput(input):!1},add:function(){return console.warn("Deprecated API is deprecated: input.add(). Use input.connect()"),this.connect.apply(this,arguments)},remove:function(){return console.warn("Deprecated API is deprecated: input.remove(). Use input.disconnect()"),this.disconnect.apply(this,arguments)},$oninput:function(input){if(input)return null===input.data?(this._mayberevoke(input),!1):this.match(input);throw new TypeError("Bad input: "+input+" "+(this.spirit||""))},_watches:null,_matches:null,_needing:null,_maybeinput:function(input){var best=Input.$bestmatch(input.type,this._watches,!0);return best?(this._updatematch(input,best),this.done=this._done(),this._updatehandlers(input),!0):!1},_mayberevoke:function(input){var matches=this._matches,watches=this._watches,best=Input.$bestmatch(input.type,watches,!0);if(best){var oldinput=matches.filter(function(input){return input.type===best})[0],index=matches.indexOf(oldinput);matches.splice(index,1),this.done=this._done(),this.done||(input.revoked=!0,this._updatehandlers(input))}},_updatematch:function(newinput,bestmatch){var matches=this._matches,oldindex=-1,oldrating=-1,newrating=Input.$rateone(newinput.type,bestmatch);matches.forEach(function(match,i){oldrating=Input.$rateone(match.type,bestmatch),oldrating>-1&&newrating>=oldrating&&(oldindex=i)}),oldindex>-1?matches[oldindex]=newinput:matches.push(newinput)},_updatehandlers:function(input){gui.Class.ancestorsAndSelf(input.type,function(Type){var list=this._trackedtypes[Type.$classid];list&&list.forEach(function(checks){var handler=checks[0];handler.oninput(input)})},this)},_done:function(){var needs=this._needing,haves=this._matches;return needs.every(function(Type){return haves.some(function(input){return input.data instanceof Type})})},_cleanup:function(classid,checks){if(this._removechecks(classid,checks)){var Type=gui.Class.get(classid);Input.$remove(Type,this)}}})}(gui.Combo.chained,edb.Input),gui.module("edb@wunderbyte.com",{plugin:{input:edb.InputPlugin}}),window.edbml=gui.namespace("edbml",{bootload:!1,declare:function(id){var configured;return{as:function($edbml){return configured=edbml.$runtimeconfigure($edbml),configured=gui.Object.assert(id,configured),configured.lock=function(out){return function(){return $edbml.$out=out,configured.apply(this,arguments)}},this},withInstructions:function(pis){configured.$instructions=pis}}},safetext:function(string){return edbml.Security.$safetext(string)},safeattr:function(string){return edbml.Security.$safeattr(string)},$set:function(action,thisp){return edbml._assign(action,thisp)},$get:function(key){return edbml._request(key)},$run:function(e,key){this._register(e),this._invoke(key)},$revoke:function(key){this._invokables[key]=null,delete this._invokables[key]},$runtimeconfigure:function(){function setupbefore($edbml,spirit){$edbml.$out=$edbml.$out||new edbml.Out,$edbml.$att=new edbml.Att,spirit&&($edbml.$input=function(Type){return spirit.script.$input.get(Type)})}function cleanupafter($edbml,spirit){$edbml.$out=null,$edbml.$att=null,spirit&&($edbml.$input=null)}return function($edbml){return function($in){setupbefore($edbml,this);var res=$edbml.apply(this,arguments);return cleanupafter($edbml,this),res}}}(),_latestevent:null,_invokables:{},_assign:function(func,thisp){var key=gui.KeyMaster.generateKey();return this._invokables[key]=function(value,checked){return func.apply(thisp,[gui.Type.cast(value),checked])},key},_invoke:function(key,sig,log){log=log||this._latestevent,sig?this._invokeremote(key,sig,log):this._invokelocal(key,log)},_invokeremote:function(key,sig,log){gui.Broadcast.$target=this,gui.Broadcast.dispatchGlobal(edb.BROADCAST_SCRIPT_INVOKE,{key:key,sig:sig,log:log})},_invokelocal:function(key,log){var func=this._invokables[key];if(func)if(log)switch(log.type){case"click":case"tap":gui.Tick.time(function(){func(log.value,log.checked)});break;default:func(log.value,log.checked)}else func();else console.error("out of synch")},_request:function(key,sig){var func;if(sig)console.error("Not supported");else{if(func=this._invokables[key])return func();console.error("out of synch")}},_register:function(e){this._latestevent=e&&e.target?{type:e.type,value:e.target.value,checked:e.target.checked}:null}}),edbml.Att=function(atts){atts&&gui.Object.extend(this,atts)},edbml.Att.prototype=gui.Object.create(null,{toString:function(){return"[object edbml.Att]"},$:function(att){var val=this[att],html="";switch(gui.Type.of(val)){case"null":case"undefined":break;default:val=edbml.Att.$encode(this[att]),html+=att+'="'+val+'" '}return html},$pop:function(att){var html=this.$(att);return delete this[att],html},$all:function(){var html="";return gui.Object.nonmethods(this).forEach(function(att){html+=this.$(att)},this),html}}),edbml.Att.$encode=function(data){var type=gui.Type.of(data);switch(type){case"string":data=edbml.safeattr(data);break;case"number":case"boolean":data=String(data);break;case"object":case"array":try{data=encodeURIComponent(JSON.stringify(data))}catch(jsonex){throw new Error("Could not create HTML attribute: "+jsonex)}break;case"date":throw new Error("TODO: edbml.Att.encode standard date format?");default:throw new Error("Could not create HTML attribute for "+type)}return data},edbml.Out=function(){},edbml.Out.prototype={html:"",toString:function(){return"[object edbml.Out]"},write:function(){return this.html}},edbml.Update=gui.Class.create(Object.prototype,{type:null,id:null,ids:null,window:null,document:null,onconstruct:function(){this._summary=[]},update:function(){},element:function(){var spirit,element=null;return gui.KeyMaster.isKey(this.id)&&(spirit=gui.get(this.id))&&(element=spirit.element),element=element||document.querySelector("#"+this.id),element||console.error("No element to match @id: "+this.id),element},dispose:function(){this._summary=null},_summary:null,_beforeUpdate:function(element){var event="x-beforeupdate-"+this.type;return this._dispatch(element,event)},_afterUpdate:function(element){var event="x-afterupdate-"+this.type;return this._dispatch(element,event)},_dispatch:function(element,name){if(element){var event=document.createEvent("UIEvents");return event.initEvent(name,!0,!0),element.dispatchEvent(event)}console.error("Occasional EDBML dysfunction just happened")},_report:function(report){edbml.debug&&(gui.KeyMaster.isKey(this.id)&&(report=report.replace(this.id,"(anonymous)")),console.debug(report,this.element()))}},{},{TYPE_HARD:"hard",TYPE_ATTS:"atts",TYPE_INSERT:"insert",TYPE_APPEND:"append",TYPE_REMOVE:"remove",TYPE_FUNCTION:"function"}),edbml.AttsUpdate=function(CSSPlugin){return edbml.Update.extend({type:edbml.Update.TYPE_ATTS,onconstruct:function(id,xnew,xold){edbml.Update.prototype.onconstruct.call(this),this.id=id,this._xnew=xnew,this._xold=xold},update:function(){edbml.Update.prototype.update.call(this);var element=this.element();element&&this._beforeUpdate(element)&&(this._update(element),this._afterUpdate(element),this._report())},dispose:function(){edbml.Update.prototype.dispose.call(this),delete this._xold,delete this._xnew},_xold:null,_xnew:null,_update:function(element){Array.forEach(this._xnew.attributes,function(newatt){var oldatt=this._xold.getAttribute(newatt.name);(null===oldatt||oldatt!==newatt.value)&&("class"===newatt.name?this._classlist(element,this._xold,newatt.value):this._set(element,newatt.name,newatt.value),this._summary.push("@"+newatt.name+'="'+newatt.value+'"'+(element.id?" (#"+element.id+")":"")))},this),Array.forEach(this._xold.attributes,function(oldatt){this._xnew.hasAttribute(oldatt.name)||("class"===oldatt.name?this._classlist(element,this._xold,""):this._del(element,oldatt.name,null),this._summary.push("removed @"+oldatt.name+(element.id?" (#"+element.id+")":"")))},this)},_set:function(element,name,value){var spirit=element.spirit;if(spirit)spirit.att.set(name,value);else switch(element.setAttribute(name,value),name){case"checked":element.checked||(element.checked=!0);break;case"value":element.value!==value&&(element.value=String(value))}},_del:function(element,name){var spirit=element.spirit;if(spirit)spirit.att.del(name);else switch(name){case"checked":element.checked=!1;break;default:element.removeAttribute(name)}},_classlist:function(element,xelement,classname){var newnames=classname.split(" "),oldnames=xelement.className.split(" ");oldnames.forEach(function(oldname){oldname&&-1===newnames.indexOf(oldname)&&CSSPlugin.remove(element,oldname)}),newnames.forEach(function(newname){newname&&-1===oldnames.indexOf(newname)&&CSSPlugin.add(element,newname)})},_report:function(){var summary=this._summary.join(", "),message='edbml.AttsUpdate "#'+this.id+'" '+summary;edbml.Update.prototype._report.call(this,message)}})}(gui.CSSPlugin),edbml.HardUpdate=edbml.Update.extend({type:edbml.Update.TYPE_HARD,xelement:null,onconstruct:function(id,xelement){edbml.Update.prototype.onconstruct.call(this),this.id=id,this.xelement=xelement},update:function(){edbml.Update.prototype.update.call(this);var element=this.element();element&&this._beforeUpdate(element)&&(gui.DOMPlugin.html(element,this.xelement.innerHTML),this._afterUpdate(element),this._report())},dispose:function(){edbml.Update.prototype.dispose.call(this),delete this.xelement},_report:function(){var message="edbml.HardUpdate #"+this.id;edbml.Update.prototype._report.call(this,message)}}),edbml.SoftUpdate=edbml.Update.extend({xelement:null,type:null,dispose:function(){edbml.Update.prototype.dispose.call(this),delete this.xelement},_import:function(parent){var temp=document.createElement(parent.nodeName);return temp.innerHTML=this.xelement.outerHTML,temp.firstChild}}),edbml.InsertUpdate=edbml.SoftUpdate.extend({type:edbml.Update.TYPE_INSERT,xelement:null,onconstruct:function(id,xelement){this.id=id,this.xelement=xelement},update:function(){var parent,child,sibling=this.element();sibling&&(parent=sibling.parentNode,child=this._import(parent),this._beforeUpdate(parent)&&(parent.insertBefore(child,sibling),this._afterUpdate(child),this._report()))},_report:function(){var message="edbml.InsertUpdate #"+this.xelement.getAttribute("id");edbml.SoftUpdate.prototype._report.call(this,message)}}),edbml.AppendUpdate=edbml.SoftUpdate.extend({type:edbml.Update.TYPE_APPEND,onconstruct:function(id,xelement){this.id=id,this.xelement=xelement},update:function(){var child,parent=this.element();parent&&(child=this._import(parent),this._beforeUpdate(parent)&&(parent.appendChild(child),this._afterUpdate(child),this._report()))},_report:function(){var message="edbml.AppendUpdate #"+this.xelement.getAttribute("id");edbml.SoftUpdate.prototype._report.call(this,message)}}),edbml.RemoveUpdate=edbml.SoftUpdate.extend({type:edbml.Update.TYPE_REMOVE,onconstruct:function(id){this.id=id},update:function(){var parent,element=this.element();element&&(parent=element.parentNode,this._beforeUpdate(element)&&(parent.removeChild(element),
this._afterUpdate(parent),this._report()))},_report:function(){var message="edbml.RemoveUpdate #"+this.id;edbml.SoftUpdate.prototype._report.call(this,message)}}),edbml.FunctionUpdate=edbml.Update.extend({type:edbml.Update.TYPE_FUNCTION,onconstruct:function(id,map){edbml.Update.prototype.onconstruct.call(this),this.id=id,this._map=map||null},update:function(){var count=0,elm=this.element();this._map?(count=edbml.FunctionUpdate._remap(elm,this._map))&&this._report("remapped "+count+" keys"):(count=edbml.FunctionUpdate._revoke(elm))&&this._report("revoked "+count+" keys")},_report:function(report){var message="edbml.FunctionUpdate "+report+" ("+this.$instanceid+")";edbml.Update.prototype._report.call(this,message)}},{_revoke:function(element){var att,keys,count=0;return this._getatts(element).forEach(function(x){att=x[1],keys=gui.KeyMaster.extractKey(att.value),keys&&keys.forEach(function(key){edbml.$revoke(key),count++})}),count},_remap:function(element,map){var oldkeys,newkey,newval,count=0;return Object.keys(map).length&&this._getatts(element).forEach(function(x){var elm=x[0],att=x[1];(oldkeys=gui.KeyMaster.extractKey(att.value))&&oldkeys.forEach(function(oldkey){(newkey=map[oldkey])&&(newval=att.value.replace(oldkey,newkey),elm.setAttribute(att.name,newval),edbml.$revoke(oldkey),count++)})}),count},_getatts:function(element){var atts=[];return new gui.Crawler("edbml-crawler-functionupdate").descend(element,{handleElement:function(elm){return elm!==element&&(Array.forEach(elm.attributes,function(att){att.value.includes("edbml.$run")&&atts.push([elm,att])}),elm.spirit&&elm.spirit.script.loaded)?gui.Crawler.SKIP_CHILDREN:void 0}}),atts}}),edbml.UpdateCollector=gui.Class.create(Object.prototype,{onconstruct:function(){this._updates=[],this._hardupdates={}},collect:function(update,ids){return this._updates.push(update),update.type===edbml.Update.TYPE_HARD?this._hardupdates[update.id]=!0:update.ids=ids||{},this},hardupdates:function(id){return this._hardupdates[id]?!0:!1},eachRelevant:function(action){this._updates.filter(function(update){return update.type===edbml.Update.TYPE_HARD||Object.keys(update.ids).every(function(id){return!this._hardupdates[id]},this)},this).forEach(function(update){action(update)})},dispose:function(){this._hardupdates=null,this._updates=null},_updates:null,_hardupdates:null}),edbml.UpdateAssistant={parse:function(markup,id,element){element=document.createElement(element.localName),element.innerHTML=markup,element.id=id,Array.forEach(element.querySelectorAll("option"),function(option){switch(option.getAttribute("selected")){case"true":option.setAttribute("selected","selected");break;case"false":option.removeAttribute("selected")}});var inputs="input[type=checkbox],input[type=radio]";return Array.forEach(element.querySelectorAll(inputs),function(option){switch(option.getAttribute("checked")){case"true":option.setAttribute("checked","checked");break;case"false":option.removeAttribute("checked")}}),element},order:function(nodes){var order={};return Array.forEach(nodes,function(node,index){node.nodeType===Node.ELEMENT_NODE&&(order[node.id]=index)},this),order},index:function(nodes){var result=Object.create(null);return Array.forEach(nodes,function(node,index){node.nodeType===Node.ELEMENT_NODE&&(result[node.id]=node)},this),result}},edbml.UpdateManager=function(HardUpdate,AttsUpdate,InsertUpdate,RemoveUpdate,AppendUpdate,FunctionUpdate){return gui.Class.create(Object.prototype,{onconstruct:function(spirit){this._keyid=spirit.dom.id()||spirit.$instanceid,this._spirit=spirit},update:function(html){this._spirit.life.destructed||(this._updates=new edbml.UpdateCollector,this._functions={},this._olddom?(this._next(html),this._updates.collect(new FunctionUpdate(this._keyid,this._functions))):this._first(html),this._updates.eachRelevant(function(update){update.update(),update.dispose()}),this._updates&&this._updates.dispose(),this._updates=null)},_keyid:null,_doc:null,_spirit:null,_olddom:null,_nedwdom:null,_updates:null,_assistant:edbml.UpdateAssistant,_first:function(html){this._olddom=this._parse(html),this._updates.collect(new HardUpdate(this._keyid,this._olddom))},_next:function(html){this._newdom=this._parse(html),this._crawl(this._newdom,this._olddom,this._newdom,this._keyid,{}),this._olddom=this._newdom},_parse:function(html){return this._assistant.parse(html,this._keyid,this._spirit.element)},_crawl:function(newchild,oldchild,lastnode,id,ids){for(var result=!0;newchild&&oldchild&&!this._updates.hardupdates(id);){switch(newchild.nodeType){case Node.TEXT_NODE:result=this._check(newchild,oldchild,lastnode,id,ids);break;case Node.ELEMENT_NODE:result=this._scan(newchild,oldchild,lastnode,id,ids)}newchild=newchild.nextSibling,oldchild=oldchild.nextSibling}return result},_scan:function(newnode,oldnode,lastnode,id,ids){var result=!0,oldid=oldnode.id;return(result=this._check(newnode,oldnode,lastnode,id,ids))&&(oldid&&(ids=gui.Object.copy(ids),lastnode=newnode,ids[oldid]=!0,id=oldid),result=this._crawl(newnode.firstChild,oldnode.firstChild,lastnode,id,ids)),result},_check:function(newnode,oldnode,lastnode,id,ids){var result=!0,isSoftUpdate=!1,isPluginUpdate=!1;if(newnode&&!oldnode||!newnode&&oldnode)result=!1;else if(result=newnode.nodeType===oldnode.nodeType)switch(oldnode.nodeType){case Node.TEXT_NODE:newnode.data!==oldnode.data&&(result=!1);break;case Node.ELEMENT_NODE:(result=this._familiar(newnode,oldnode))&&(result=this._checkatts(newnode,oldnode,ids))&&(this._maybesoft(newnode,oldnode)?(this._confirmsoft(newnode,oldnode)&&(this._updatesoft(newnode,oldnode,ids),isSoftUpdate=!0),result=!1):"textarea"!==oldnode.localName&&(result=newnode.childNodes.length===oldnode.childNodes.length,!result&&oldnode.id&&(lastnode=newnode,id=oldnode.id)))}return result||isSoftUpdate||isPluginUpdate||(this._updates.collect(new FunctionUpdate(id)),this._updates.collect(new HardUpdate(id,lastnode))),result},_familiar:function(newnode,oldnode){return["namespaceURI","localName"].every(function(prop){return newnode[prop]===oldnode[prop]})},_checkatts:function(newnode,oldnode,ids){var result=!0,update=null;if(this._attschanged(newnode.attributes,oldnode.attributes,ids)){var newid=newnode.id,oldid=oldnode.id;newid&&newid===oldid?(update=new AttsUpdate(oldid,newnode,oldnode),this._updates.collect(update,ids)):result=!1}return result},_attschanged:function(newatts,oldatts,ids){var changed=newatts.length!==oldatts.length;return changed||(changed=!Array.every(newatts,function(newatt){var oldatt=oldatts.getNamedItem(newatt.name);return oldatt&&(oldatt.value===newatt.value||this._onlyedbmlchange(newatt.value,oldatt.value))},this)),changed},_onlyedbmlchange:function(newval,oldval){if([newval,oldval].every(function(val){return val.includes("edbml.$")})){var newkey,newkeys=gui.KeyMaster.extractKey(newval),oldkeys=gui.KeyMaster.extractKey(oldval);if(newkeys&&oldkeys)return oldkeys.forEach(function(oldkey,i){newkey=newkeys[i],newval=newval.replace(newkey,""),oldval=oldval.replace(oldkey,""),this._functions[oldkey]=newkey},this),newval===oldval}return!1},_maybesoft:function(newnode,oldnode){return newnode&&oldnode?newnode.id&&newnode.id===oldnode.id&&this._maybesoft(newnode)&&this._maybesoft(oldnode):Array.every(newnode.childNodes,function(node){var res=!0;switch(node.nodeType){case Node.TEXT_NODE:res=""===node.data.trim();break;case Node.ELEMENT_NODE:res=""!==node.id}return res},this)},_confirmsoft:function(newnode,oldnode){var res=!0,prev=null,oldorder=this._assistant.order(oldnode.childNodes);return Array.every(newnode.childNodes,function(node,index){if(node.nodeType===Node.ELEMENT_NODE){var id=node.id;oldorder.hasOwnProperty(id)&&oldorder.hasOwnProperty(prev)&&(res=oldorder[id]>oldorder[prev]),prev=id}return res},this)},_updatesoft:function(newnode,oldnode,ids){for(var updates=[],news=this._assistant.index(newnode.childNodes),olds=this._assistant.index(oldnode.childNodes),child=newnode.lastElementChild,topid=oldnode.id,oldid=null,newid=null;child;)newid=child.id,olds[newid]?oldid=newid:oldid?updates.push(new InsertUpdate(oldid,child)):updates.push(new AppendUpdate(topid,child)),child=child.previousElementSibling;Object.keys(olds).forEach(function(id){if(news[id]){var n1=news[id],n2=olds[id];this._scan(n1,n2,n1,id,ids)}else updates.push(new RemoveUpdate(id)),updates.push(new FunctionUpdate(id))},this),updates.reverse().forEach(function(update){this._updates.collect(update,ids)},this)}})}(edbml.HardUpdate,edbml.AttsUpdate,edbml.InsertUpdate,edbml.RemoveUpdate,edbml.AppendUpdate,edbml.FunctionUpdate),edbml.ScriptPlugin=function(chained,confirmed){return gui.Plugin.extend({loaded:!1,ran:!1,debug:!1,onconstruct:function(){gui.Plugin.prototype.onconstruct.call(this),this._oldfokkers={},this._newfokkers={}},ondestruct:function(){gui.Plugin.prototype.ondestruct.call(this),this.loaded&&(gui.Tick.cancelFrame(this._frameindex),this.spirit.life.remove(gui.LIFE_ENTER,this),gui.Broadcast.remove(edb.BROADCAST_ACCESS,this),this.$input&&(this.$input.ondestruct(),this.$input.$ondestruct()))},load:chained(confirmed("function|string")(function(script){script=gui.Type.isFunction(script)?script:gui.Object.lookup(script),script&&(this.loaded=!0,this._script=script,this._updater=new edbml.UpdateManager(this.spirit),this._process(script.$instructions),this.$input||this.run())})),oninput:function(input){this.loaded?input.revoked?this.write(""):(!this.$input||this.$input.done)&&this._schedule():this._notloaded()},run:function(){gui.Tick.cancelFrame(this._frameindex),this.loaded?!this.$input||this.$input.done?this.spirit.life.entered?this.write(this._run.apply(this,arguments)):(this.spirit.life.add(gui.LIFE_ENTER,this),this._arguments=arguments):this._notready():this._notloaded()},write:function(html){var changed=this._html!==html,focused=this._focusedfield();changed&&(this._html=html,this._updater.update(html),focused&&this._restorefocus(focused)),this._status(this.spirit),this.ran=!0},input:function(){var types,input;if(input=this.$input){if(this.loaded)return types=gui.Array.make(arguments).map(function(type){return input.$oninput(new edb.Input(type.constructor,type)),type}),types.length>1?types:types[0];this._notloaded()}else this._noinputexpected()},revoke:function(){gui.Array.make(arguments).forEach(function(type){var Type=edb.Type.is(type)?type.constructor:type;this.$input.$oninput(new edb.Input(Type,null))},this)},onbroadcast:function(b){var keys=this._newfokkers;switch(b.type){case edb.BROADCAST_ACCESS:var type=b.data[0],name=b.data[1],id=type.$instanceid;keys[id]||(keys[id]={object:type},name&&(keys[id].properties={})),name&&(keys[id].properties[name]=!0)}},onchange:function(changes){changes.some(function(c){var id=c.object.$instanceid,clas=c.object.$classname,name=c.name;if(!edbml.$rendering||!edbml.$rendering[id]){var props=this._oldfokkers[id].properties;try{if(!name||props[name])return!0}catch(todoexception){}return!1}console.error("Don't update \""+name+'" of the '+clas+" while rendering, it will cause the rendering to run in an endless loop. ")},this)&&this._schedule()},onlife:function(l){l.type===gui.LIFE_ENTER&&(this.spirit.life.rendered||this.run.apply(this,this._arguments||[]),this.spirit.life.remove(l.type,this),this._arguments=null)},$input:null,_src:null,_script:null,_updater:null,_oldfokkers:null,_arguments:null,_html:null,_frameindex:-1,_process:function(pis){if(pis){var optional=[],required=[];pis.reduce(function(hasinput,pi){var keys=Object.keys(pi),name=keys[0],atts=pi[name];if("input"===name){var list=atts.required===!1?optional:required;return list.push(gui.Object.lookup(atts.type)),!0}return hasinput},!1)&&(this.$input=new edb.InputPlugin,this.$input.connect(required,this,!0),this.$input.connect(optional,this,!1))}},_start:function(){edbml.$rendering=this._oldfokkers||{},gui.Broadcast.add(edb.BROADCAST_ACCESS,this),edb.$accessaware=!0,this._newfokkers={}},_stop:function(){var oldfokkers=this._oldfokkers,newfokkers=this._newfokkers;edbml.$rendering=null,gui.Broadcast.remove(edb.BROADCAST_ACCESS,this),edb.$accessaware=!1,Object.keys(oldfokkers).forEach(function(id){newfokkers[id]||(oldfokkers[id].object.removeObserver(this),delete oldfokkers[id])},this),Object.keys(newfokkers).forEach(function(id){var oldx=oldfokkers[id],newx=newfokkers[id];oldx?newx.properties&&(oldx.properties=newx.properties):(oldfokkers[id]=newfokkers[id],oldfokkers[id].object.addObserver(this),delete newfokkers[id])},this),this._newfokkers=null},_schedule:function(){gui.Tick.cancelFrame(this._frameindex);var spirit=this.spirit,input=this.$input,runnow=function(){spirit.life.destructed||input&&!input.done||this.run()}.bind(this);spirit.life.entered?spirit.life.rendered?this._frameindex=gui.Tick.nextFrame(runnow):runnow():spirit.life.add(gui.LIFE_ENTER,this)},_status:function(spirit){spirit.life.rendered=!0,spirit.onrender({first:!this.ran}),spirit.life.dispatch(gui.LIFE_RENDER)},_run:function(){this._start();var html=this._script.apply(this.spirit,arguments);return this._stop(),html},_notready:function(){var type,input=this.$input;(input._watches||[]).forEach(function(Type){(type=edb.get(Type))&&input.$oninput(new edb.Input(Type,type))},this)},_notloaded:function(){console.error("Spiritual EDBML: No script loaded for "+this.spirit)},_noinputexpected:function(){console.error("Spiritual EDBML: No input expected for "+this.spirit)},_focusedfield:function(){var focused;try{focused=document.activeElement}catch(ieException){focused=null}return focused&&gui.DOMPlugin.contains(this.spirit.element,focused)?this._focusselector(focused):null},_focusselector:function(elm){function hasid(elm){if(elm.id)try{return gui.DOMPlugin.q(elm.parentNode,elm.id),!0}catch(malformedexception){}return!1}for(var index=-1,parts=[];elm&&elm.nodeType===Node.ELEMENT_NODE;)hasid(elm)?(parts.push("#"+elm.id),elm=null):"body"===elm.localName?(parts.push("body"),elm=null):(index=gui.DOMPlugin.ordinal(elm)+1,parts.push(">"+elm.localName+":nth-child("+index+")"),elm=elm.parentNode);return parts.reverse().join("")},_restorefocus:function(selector){var focus,texts="textarea, input:not([type=checkbox]):not([type=radio])",field=gui.DOMPlugin.qdoc(selector);try{focus=document.activeElement}catch(ieException){focus=null}field&&field!==focus&&(field.focus(),gui.CSSPlugin.matches(field,texts)&&field.setSelectionRange(field.value.length,field.value.length))}})}(gui.Combo.chained,gui.Arguments.confirmed),edbml.ScriptSpirit=gui.Spirit.extend({scriptid:null,onconfigure:function(){if(gui.Spirit.prototype.onconfigure.call(this),this.dom.embedded()){var id,parent=this.dom.parent(gui.Spirit);parent&&(id=this.scriptid)&&parent.script.load(gui.Object.lookup(id))}}}),edbml.Security=function(safeelm,safemap,unsafexp){return{$safetext:function(string){return safeelm.firstChild.data=String(string),safeelm.innerHTML},$safeattr:function(string){return String(string).replace(unsafexp,function(c){return safemap[c]})}}}(function(){var div=document.createElement("div"),txt=document.createTextNode("");return div.appendChild(txt),div}(),function(){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}}(),/[&<>'"]/g),gui.module("edbml@wunderbyte.com",{mixin:{src:function(script){if(gui.Type.isString(script)){var func=gui.Object.lookup(script);if(!func)throw new Error(this+' could not locate "'+script+'"');script=func}if(!gui.Type.isFunction(script))throw new TypeError(this+" could not load script");this.script.load(script)},onrender:function(summary){},onchange:function(changes){},oninput:function(input){},$oninput:function(input){this.script.input.match(input)}},plugin:{script:edbml.ScriptPlugin},channel:[[".gui-script","edbml.ScriptSpirit"]],oncontextinitialize:function(){var edbmlscript,basespirit=gui.Spirit.prototype;if(gui.Function.decorateAfter(basespirit,"onconfigure",function(){edbml.bootload&&!this.script.loaded&&(edbmlscript=gui.Object.lookup(this.$classname+".edbml"),gui.Type.isFunction(edbmlscript)&&this.script.load(edbmlscript))}),!window.event)try{window.event=null}catch(ieexception){}}})}(self),function(window){"use strict";window.ghp=gui.namespace("ghp"),ghp.LinkSpirit=gui.Spirit.extend({onready:function(){gui.Spirit.prototype.onready.call(this),this.event.add("click")},onevent:function(e){gui.Spirit.prototype.onevent.call(this,e),"click"===e.type&&this._doaction()&&(this.action.dispatch("action-load",this.element.href),e.preventDefault())},_doaction:function(){return gui.Client.hasHistory&&!this.att.get("href").includes("//")&&!this._is("#")&&!this._is("javascript:")},_is:function(prefix){return this.att.get("href").startsWith(prefix)}}),ghp.PageSpirit=function(){var menumodel;return gui.Spirit.extend({onready:function(){gui.Spirit.prototype.onready.call(this),this.event.add("hashchange",window),gui.Client.hasHistory&&(this.event.add("popstate",window),this.action.add("action-load")),this._zzzz(),this._menu(),this._done()},onaction:function(a){switch(gui.Spirit.prototype.onaction.call(this,a),a.type){case"action-load":var href=a.data;history.pushState(null,null,href),this._load(href),a.consume()}},onevent:function(e){switch(gui.Spirit.prototype.onevent.call(this,e),e.type){case"popstate":this._load(location.href);break;case"hashchange":}},_load:function(href){var path=new gui.URL(document,href).pathname;new gui.Request(href).acceptText().get().then(function(status,html){html=gui.HTMLParser.parseToDocument(html),this._main(html),this._xxxx(path)&&(this._zzzz(html),this._menu()),this._loaded()},this)},_xxxx:function(path){var section,html=document.documentElement;return path&&(section=path.split("/")[1])&&section!==html.id?(html.id=section,!0):void 0},_zzzz:function(html){var nav=(html||document).querySelector("#nav");menumodel=new ghp.MenuModel({items:gui.Array.from(nav.children).map(function item(li){var link=li.firstElementChild,menu=li.querySelector("nav");return{label:link.textContent,href:link.getAttribute("href"),items:menu?gui.Array.from(menu.children).map(item):void 0}})}).output()},_main:function(html){document.title=html.querySelector("title").textContent;var root=document.querySelector("div"),main=document.importNode(html.querySelector("main"),!0);root.replaceChild(main,document.querySelector("main"))},_loaded:function(){window.scrollTo(0,0),this._menu(),this._done()},_menu:function(){var page=location.pathname;page=page.includes(".html")?page:page+"index.html",menumodel.select(page)},_done:function(){this._jump()},_jump:function(){var elm,hash=location.hash;hash&&(elm=document.querySelector(hash))&&elm.scrollIntoView()}})}(),ghp.NavSpirit=gui.Spirit.extend({onconfigure:function(){gui.Spirit.prototype.onconfigure.call(this),this.script.load(ghp.NavSpirit.edbml)}}),ghp.ItemModel=edb.Object.extend({selected:!1,open:!1,label:null,href:null}),ghp.ItemModel.prototype.items=edb.Array({$of:ghp.ItemModel}),ghp.MenuModel=edb.Object.extend({items:edb.Array({$of:ghp.ItemModel}),select:function(href){this.items.forEach(function(item){item.selected=item.href===href,item.open=item.items.reduce(function(was,sub){return sub.selected=sub.href===href,was||sub.selected},!1)||item.selected&&item.items.length})}}),gui.module("ghp@wunderbyte.com",{oncontextinitialize:function(){ghp.spacename(),gui.debug=location.href.includes("localhost")},channel:[["a[href]",ghp.LinkSpirit],["body",ghp.PageSpirit],["#nav",ghp.NavSpirit]]})}(self),edbml.declare("ghp.NavSpirit.edbml").as(function $edbml(){"use strict";var out=$edbml.$out,$att=$edbml.$att,$txt=edbml.safetext,$val=edbml.safeattr,menu=$edbml.$input(ghp.MenuModel);return menu.items.forEach(function doitem(item){out.html+="<li>",$att.id=item.$instanceid,$att["class"]=item.selected?"selected":null,out.html+="<a "+$att.$("id")+" "+$att.$("class")+' href="'+$val(item.href)+'">'+$txt(item.label)+"</a>",item.open&&(out.html+="<nav "+$att.$("id")+">",item.items.forEach(doitem),out.html+="</nav>"),out.html+="</li>"}),out.write()}).withInstructions([{input:{name:"menu",type:"ghp.MenuModel"}}]);
//# sourceMappingURL=scripts.min.js.map